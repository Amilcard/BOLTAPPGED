{
  "context": "Tunnel inscription PRO - 3 bugs critiques identifiés",
  "fichier": "components/booking-flow.tsx",

  "bug_1_prix_non_affiche": {
    "severity": "MEDIUM",
    "ligne_probleme": 194,
    "code_actuel": "{(step === 2 || step === 3 || step === 4) && selectedSession && totalPrice !== null && (...)}",
    "symptome": "Prix total n'apparaît pas à l'étape 5 (step 4 dans le code)",
    "cause": "Condition L194 exclut step 4 (étape 5/5 visuelle) du sticky recap",
    "expected": "Le sticky recap avec prix doit apparaître aussi à step 4",
    "fix": {
      "ligne": 194,
      "avant": "(step === 2 || step === 3 || step === 4)",
      "apres": "(step >= 2 && step <= 4)",
      "explication": "Simplifie condition ET garantit affichage à toutes étapes nécessaires"
    }
  },

  "bug_2_pas_de_redirect": {
    "severity": "LOW",
    "ligne_probleme": 169,
    "code_actuel": "setStep(5);",
    "symptome": "Après confirmation, aucune redirection - on reste sur même écran",
    "cause": "setStep(5) change juste l'étape interne, pas de navigation",
    "analyse": "En fait, ce n'est PAS un bug - step 5 affiche écran succès (L562-584)",
    "verification": "L562: {step === 5 && (...)} affiche bien confirmation",
    "conclusion": "COMPORTEMENT NORMAL - l'écran de confirmation s'affiche"
  },

  "bug_3_validation_age_absente": {
    "severity": "CRITICAL",
    "description": "Aucune validation âge enfant vs tranche séjour",
    "risque_reglementaire": "Inscription hors tranche d'âge possible",
    "lignes_concernees": [73, 462, 505, 550],

    "analyse": {
      "calcul_age_existe": "L73-83: fonction calculateAge() présente",
      "affichage_age": "L462-466: âge affiché mais pas validé",
      "isStep2Valid": "L131: vérifie consent + champs mais PAS l'âge",
      "handleSubmit": "L135-175: aucune validation âge avant POST"
    },

    "donnees_disponibles": {
      "age_enfant": "calculateAge(step2.childBirthDate) → calculé dynamiquement",
      "age_min_sejour": "stay.ageMin (disponible via props)",
      "age_max_sejour": "stay.ageMax (disponible via props)"
    },

    "fix_requis": {
      "validation_frontend": {
        "ou": "step 3 (après saisie date naissance)",
        "logique": "if (age < stay.ageMin || age > stay.ageMax) { setError(...) }",
        "bloquer_continuer": "disabled si âge invalide"
      },
      "validation_step4": {
        "ou": "step 4 (avant handleSubmit)",
        "logique": "const ageValide = age >= stay.ageMin && age <= stay.ageMax",
        "affichage": "Message d'erreur clair si invalide",
        "bloquer_confirmer": "disabled={!ageValide || loading}"
      },
      "validation_backend": {
        "fichier": "app/api/inscriptions/route.ts",
        "securite": "Double validation côté serveur (obligatoire)"
      }
    }
  },

  "solution_recommandee": {
    "approche": "Valider âge à step 3 (UX optimal)",
    "implementation": {
      "1_ajouter_state": "const [ageError, setAgeError] = useState('');",
      "2_useEffect_watch_birthdate": {
        "code": "useEffect(() => {\n  if (!step2.childBirthDate || !stay.ageMin || !stay.ageMax) return;\n  const age = calculateAge(step2.childBirthDate);\n  if (age === null) return;\n  if (age < stay.ageMin || age > stay.ageMax) {\n    setAgeError(`Âge requis : ${stay.ageMin}-${stay.ageMax} ans`);\n  } else {\n    setAgeError('');\n  }\n}, [step2.childBirthDate, stay.ageMin, stay.ageMax]);"
      },
      "3_afficher_erreur": "Sous input date_naissance (L462)",
      "4_bloquer_continuer": "disabled={!isStep2Valid || ageError !== ''}"
      },
      "5_validation_backend": "Ajouter check côté API /api/inscriptions"
    }
  },

  "priority_fix": {
    "bug_1": "MEDIUM - Afficher prix à étape 5",
    "bug_2": "N/A - Pas un bug (step 5 affiche succès)",
    "bug_3": "CRITICAL - Bloquer si âge invalide"
  },

  "no_regression": {
    "structure": "✅ Inchangée",
    "layout": "✅ Inchangé",
    "flow": "✅ Préservé"
  }
}
