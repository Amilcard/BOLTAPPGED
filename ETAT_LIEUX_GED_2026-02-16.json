{
  "project": "GED_APP",
  "date": "2026-02-16",
  "branch": "work",
  "last_commit": "728d62e fix: apiVersion Stripe + types TS booking-flow/modal",
  "typescript_errors": 0,
  "conflict_markers": 0,

  "done": {
    "database_integrity": {
      "status": "PRODUCTION",
      "fk_constraints": [
        "fk_stay_sessions_stay (gd_stay_sessions.stay_slug → gd_stays.slug) — VALIDATED",
        "fk_session_prices_stay (gd_session_prices.stay_slug → gd_stays.slug) — VALIDATED",
        "fk_inscriptions_stay (gd_inscriptions.sejour_slug → gd_stays.slug) — VALIDATED"
      ],
      "composite_fk_inscription_session": "IMPOSSIBLE — gd_inscriptions stocke session_date (start_date) mais pas end_date. Clé naturelle session = (stay_slug, start_date, end_date). Documenté pour V2 avec session_id UUID.",
      "orphan_monitoring": "v_orphaned_records VIEW créée — 0 orphelins détectés",
      "indexes": "4 index performances créés sur FK columns",
      "idempotency_table": "gd_processed_events créée (event_id UNIQUE + RLS service_role)"
    },

    "financial_security": {
      "status": "CODE PUSHÉ — prêt pour production",
      "price_verification_backend": {
        "file": "app/api/inscriptions/route.ts",
        "detail": "Requête gd_session_prices (stay_slug + start_date + city_departure). Rejet PRICE_MISMATCH si écart > 1€. Prix serveur forcé comme source de vérité."
      },
      "payment_intent_secured": {
        "file": "app/api/payment/create-intent/route.ts",
        "detail": "Lit inscription.price_total en DB. Ne prend PLUS de amount frontend. Refuse si price_total <= 0."
      },
      "webhook_idempotency": {
        "file": "app/api/webhooks/stripe/route.ts",
        "detail": "Check event.id dans gd_processed_events avant traitement. Skip si déjà traité."
      },
      "webhook_amount_check": {
        "file": "app/api/webhooks/stripe/route.ts",
        "detail": "Compare paymentIntent.amount/100 vs inscription.price_total. Si mismatch > 1€ → payment_status = 'amount_mismatch', NE marque PAS 'paid'."
      }
    },

    "booking_flow_fixes": {
      "status": "CODE PUSHÉ",
      "invalid_date_fix": "reserver/page.tsx — sessions filtrées si start_date/end_date null (avant: passait null à formatDateLong)",
      "price_calculation_robust": "booking-flow.tsx — isNaN guard sur Date, fallback chain robuste pour sessionBasePrice",
      "age_validation_server": "inscriptions/route.ts — validation 3-17 ans côté serveur (birthDate parsing + calcul âge)",
      "stayid_optional": "bookings/route.ts — stayId rendu optionnel, dérivé de session.stayId si absent"
    },

    "branding_logo": {
      "status": "PUSHÉ",
      "detail": "Nouveau logo SVG, favicon, couleurs harmonisées (#2a383f primary, #de7356 secondary)"
    },

    "admin_migration_supabase": {
      "status": "PUSHÉ",
      "detail": "14/14 tables RLS activées. APIs admin migrées de Prisma vers Supabase."
    },

    "email_system": {
      "status": "CODE PUSHÉ — clés .env à configurer",
      "provider": "Resend (resend@6.9.2)",
      "functions": ["sendInscriptionConfirmation", "sendAdminNewInscriptionNotification", "sendStatusChangeEmail"],
      "from_email": "noreply@groupeetdecouverte.fr"
    }
  },

  "pieges_critiques": {
    "PIEGE_1_DEUX_CIRCUITS_BOOKING": {
      "severity": "HAUTE",
      "detail": "booking-flow.tsx ET booking-modal.tsx appellent /api/bookings (Prisma, DEPRECATED). Le circuit sécurisé est /api/inscriptions (Supabase + vérification prix). Les patchs financiers protègent /api/inscriptions mais PAS /api/bookings.",
      "impact": "Si un utilisateur arrive sur le flow qui appelle /api/bookings, les vérifications prix sont BYPASSED.",
      "fix_requis": "Migrer booking-flow.tsx et booking-modal.tsx vers /api/inscriptions, OU désactiver /api/bookings."
    },
    "PIEGE_2_RESERVER_PAGE_NULL_DATES": {
      "severity": "MOYENNE",
      "detail": "reserver/page.tsx mappe les sessions mais ne filtre PAS les dates null dans la version actuelle sur origin/work (le fix initial a pu être écrasé par le merge --theirs).",
      "fix_requis": "Vérifier que le filtre .filter(s => s.start_date && s.end_date) est bien présent."
    },
    "PIEGE_3_ENV_PRODUCTION_VIDE": {
      "severity": "HAUTE",
      "detail": ".env.production ne contient QUE NEXT_DISABLE_STATIC_PAGE_GENERATION=true. Aucune clé Stripe, Supabase, ou Resend.",
      "impact": "Le déploiement VPS crashera si les variables ne sont pas injectées au runtime (Docker env ou .env sur le serveur).",
      "fix_requis": "Configurer les .env sur le VPS AVANT le deploy."
    },
    "PIEGE_4_SUPABASE_ANON_KEY_HARDCODED": {
      "severity": "MOYENNE",
      "detail": "lib/supabaseGed.ts contient la anon key en dur comme fallback. Pas critique (anon key est publique par design Supabase) mais pas propre.",
      "fix_recommande": "Supprimer le fallback, forcer NEXT_PUBLIC_SUPABASE_ANON_KEY dans .env."
    },
    "PIEGE_5_PRISMA_SQLITE_RESIDUEL": {
      "severity": "BASSE",
      "detail": "DATABASE_URL='file:./prisma/dev.db' dans .env. Le circuit /api/bookings utilise encore Prisma/SQLite. Ce circuit est DEPRECATED mais toujours actif.",
      "fix_recommande": "Supprimer /api/bookings et toutes les dépendances Prisma une fois la migration confirmée."
    },
    "PIEGE_6_STRIPE_API_VERSION": {
      "severity": "BASSE",
      "detail": "apiVersion '2026-01-28.clover' est configuré. Vérifier que la version du SDK Stripe (^20.3.1) supporte bien cette apiVersion.",
      "fix_recommande": "Tester en Stripe test mode avant go-live."
    }
  },

  "en_attente_go_live": {
    "1_migrer_frontend_vers_api_inscriptions": {
      "priority": "P0 — BLOQUANT",
      "detail": "booking-flow.tsx et booking-modal.tsx doivent appeler /api/inscriptions (pas /api/bookings) pour bénéficier de la vérification prix backend.",
      "effort": "1-2h"
    },
    "2_configurer_env_vps": {
      "priority": "P0 — BLOQUANT",
      "keys_required": [
        "STRIPE_SECRET_KEY (sk_live_...)",
        "STRIPE_PUBLISHABLE_KEY (pk_live_...)",
        "STRIPE_WEBHOOK_SECRET (whsec_...)",
        "EMAIL_SERVICE_API_KEY (Resend API key)",
        "SUPABASE_SERVICE_ROLE_KEY (real key)",
        "NEXT_PUBLIC_SUPABASE_URL",
        "NEXT_PUBLIC_SUPABASE_ANON_KEY"
      ]
    },
    "3_deploy_vps": {
      "priority": "P1",
      "steps": ["git pull origin work", "docker build", "docker compose up -d", "vérifier healthcheck"]
    },
    "4_verifier_domaine_resend": {
      "priority": "P1",
      "detail": "Vérifier DNS pour groupeetdecouverte.fr dans dashboard Resend."
    },
    "5_tester_stripe_test_mode": {
      "priority": "P1",
      "detail": "Parcours complet inscription → paiement → webhook en mode test avant de switcher en live."
    },
    "6_desactiver_api_bookings": {
      "priority": "P2",
      "detail": "Une fois la migration frontend confirmée, supprimer /api/bookings et les dépendances Prisma."
    }
  },

  "v2_roadmap": {
    "session_id_uuid": "Ajouter gd_inscriptions.session_id UUID → FK vers gd_stay_sessions. Nécessite backfill + refactor /api/inscriptions.",
    "seats_management": "Implémenter décrément places dans gd_stay_sessions lors d'une inscription (actuellement seatsLeft est hardcodé/variable)",
    "campaign_system": "Système de campagnes/communications (campaign_live: false)",
    "stripe_live": "Passage en mode live Stripe (actuellement test keys)"
  }
}
