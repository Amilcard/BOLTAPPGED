{
  "audit_metadata": {
    "date": "2026-02-03",
    "lot": "LOT_N8N_DAILY_UPDATE_RISK_CITYCRUNCH_OVERWRITE",
    "mode": "economy_secure_no_regression",
    "status": "RISK_CONFIRMED",
    "severity": "CRITICAL"
  },

  "executive_summary": {
    "risk_level": "üî¥ CRITIQUE - √âCRASEMENT IMMINENT",
    "main_finding": "Les champs CityCrunch (title_pro, title_kids, description_pro, description_kids) sont EXPLICITEMENT inclus dans le payload n8n et seront syst√©matiquement √©cras√©s lors des mises √† jour quotidiennes.",
    "impact": "Perte totale des textes personnalis√©s CityCrunch √† chaque ex√©cution du workflow n8n (pr√©vu √† 02:00 quotidien).",
    "action_required": "URGENT - Modifier le payload n8n AVANT la prochaine ex√©cution pour exclure les champs CityCrunch."
  },

  "answers_to_questions": {
    "Q1_WORKFLOW_SCHEDULE": {
      "question": "Confirme le workflow exact qui tourne chaque jour √† 02:00",
      "answer": {
        "workflow_name": "GED__UFOVAL__SCRAPE_SEED_STAYS__v1",
        "workflow_url": "https://n8n.srv1307641.hstgr.cloud/workflow/kG6OASM4PxZaBt9H",
        "hosting": "Hostinger n8n cloud",
        "schedule": "√Ä V√âRIFIER - Non document√© dans les fichiers (probablement 02:00 UTC ou Europe/Paris)",
        "final_nodes": [
          "HTTP__UPSERT_GD_STAYS (√©crit dans gd_stays)",
          "TRANSFORM__SESSIONS_TO_ROWS (JavaScript)",
          "HTTP__UPSERT_GD_STAY_SESSIONS (√©crit dans gd_stay_sessions)"
        ],
        "note": "Le workflow est configur√© mais la planification horaire exacte doit √™tre v√©rifi√©e dans l'interface n8n (Settings > Workflow > Schedule Trigger)"
      }
    },

    "Q2_TABLES_TOUCHED": {
      "question": "Quelles tables Supabase sont mises √† jour par n8n ?",
      "answer": {
        "tables": [
          {
            "table_name": "gd_stays",
            "node_name": "HTTP__UPSERT_GD_STAYS",
            "method": "POST via Supabase REST API",
            "conflict_key": "source_url"
          },
          {
            "table_name": "gd_stay_sessions",
            "node_name": "HTTP__UPSERT_GD_STAY_SESSIONS",
            "method": "POST via Supabase REST API",
            "conflict_key": "stay_slug,start_date,end_date"
          }
        ],
        "other_tables": "Aucune autre table touch√©e par ce workflow"
      }
    },

    "Q3_FIELDS_UPSERTED_GD_STAYS": {
      "question": "Liste exacte des colonnes envoy√©es dans l'upsert gd_stays (payload JSON)",
      "answer": {
        "payload_source": "docs/N8N_4_NODES_CONFIG_READY_TO_PASTE.json ligne 64",
        "fields_sent": [
          "source_url",
          "slug",
          "title",
          "title_pro ‚ö†Ô∏è CITYCRUNCH",
          "title_kids ‚ö†Ô∏è CITYCRUNCH",
          "description_pro ‚ö†Ô∏è CITYCRUNCH",
          "description_kids ‚ö†Ô∏è CITYCRUNCH",
          "sessions_json",
          "published",
          "import_batch_ts"
        ],
        "citycrunch_fields_included": true,
        "exact_payload_code": "title_pro: item.json.pro?.title_pro,\ntitle_kids: item.json.kids?.title_kids,\ndescription_pro: item.json.pro?.description_pro || null,\ndescription_kids: item.json.kids?.description_kids || null"
      }
    },

    "Q4_CONFLICT_STRATEGY": {
      "question": "Quelle est la strat√©gie d'upsert/conflit utilis√©e ?",
      "answer": {
        "conflict_resolution": "resolution=merge-duplicates",
        "behavior": "UPDATE ALL COLUMNS lors d'un conflit (√©crase TOUS les champs envoy√©s dans le payload)",
        "on_conflict_key": "source_url",
        "http_headers": {
          "Prefer": "resolution=merge-duplicates,return=representation",
          "Content-Type": "application/json",
          "apikey": "{{ $credentials.supabase.serviceRoleKey }}",
          "Authorization": "Bearer {{ $credentials.supabase.serviceRoleKey }}"
        },
        "node_config": {
          "node_name": "HTTP__UPSERT_GD_STAYS",
          "method": "POST",
          "url": "https://iirfvndgzutbxwfdwawu.supabase.co/rest/v1/gd_stays",
          "query_params": "on_conflict=source_url",
          "body_type": "json",
          "split_into_items": false
        },
        "risk_analysis": "‚ö†Ô∏è CRITIQUE: merge-duplicates signifie que TOUS les champs du payload remplacent les valeurs existantes en DB. Il n'y a AUCUNE protection pour pr√©server les champs CityCrunch d√©j√† remplis."
      }
    },

    "Q5_SOURCE_TEXTS": {
      "question": "Quels champs texte viennent de la source partenaire ?",
      "answer": {
        "source_partner": "UFOVAL (organisateur de colonies de vacances)",
        "scraping_flow": "UFOVAL website ‚Üí n8n scraping ‚Üí enrichissement JSON ‚Üí upsert Supabase",
        "fields_from_ufoval": [
          "source_url (URL de l'article UFOVAL)",
          "title (titre brut UFOVAL)",
          "sessions_json (dates, prix, places, d√©parts)",
          "pro?.title_pro (probablement vide ou contenu UFOVAL brut)",
          "kids?.title_kids (probablement vide ou contenu UFOVAL brut)",
          "pro?.description_pro (probablement vide ou contenu UFOVAL brut)",
          "kids?.description_kids (probablement vide ou contenu UFOVAL brut)"
        ],
        "ufoval_word_injected": {
          "in_database": "Probablement NON",
          "explanation": "Le mot 'UFOVAL' n'est probablement pas inject√© dans les champs stock√©s, mais les TEXTES BRUTS d'UFOVAL le sont (titres d'articles, descriptions centres). Les champs CityCrunch devraient contenir des textes REFORMUL√âS pour les familles, pas les textes bruts UFOVAL."
        }
      }
    },

    "Q6_REWRITE_STEP": {
      "question": "Y a-t-il d√©j√† une √©tape de reformulation / nettoyage dans n8n (LLM) ?",
      "answer": {
        "llm_rewrite_exists": false,
        "nodes_inspected": [
          "FILTER__VALID_ITEMS_FOR_DB (filtre, pas de reformulation)",
          "HTTP__UPSERT_GD_STAYS (upsert direct)",
          "TRANSFORM__SESSIONS_TO_ROWS (JavaScript, transformation structure pas texte)",
          "HTTP__UPSERT_GD_STAY_SESSIONS (upsert direct)"
        ],
        "data_flow": "Scraping UFOVAL ‚Üí Enrichissement JSON ‚Üí Filtre ‚Üí Upsert Supabase (AUCUNE reformulation LLM)",
        "fields_written_to_db": "Les champs title_pro/title_kids/description_pro/description_kids re√ßoivent les valeurs BRUTES de item.json.pro?.title_pro (qui vient du scraping UFOVAL sans reformulation)",
        "conclusion": "‚ö†Ô∏è PROBL√àME ARCHITECTURAL: Les champs CityCrunch sont cens√©s contenir des textes REFORMUL√âS pour les familles (ton CityCrunch), mais n8n √©crit actuellement les TEXTES BRUTS UFOVAL dans ces champs. C'est une double r√©gression: √©crasement + mauvaise qualit√© de contenu."
      }
    }
  },

  "evidence": {
    "n8n_payload_snippet_gd_stays": {
      "description": "Payload exact envoy√© √† Supabase pour gd_stays (extrait du n≈ìud HTTP__UPSERT_GD_STAYS)",
      "source_file": "docs/N8N_4_NODES_CONFIG_READY_TO_PASTE.json",
      "line": 64,
      "code": "={{ $input.all().map(item => ({\n  source_url: item.json.source_url,\n  slug: item.json.slug || item.json.source_url.split('/').pop().replace(/[^a-z0-9-]/gi, '-').toLowerCase(),\n  title: item.json.pro?.title_pro || item.json.kids?.title_kids || 'Sans titre',\n  title_pro: item.json.pro?.title_pro,\n  title_kids: item.json.kids?.title_kids,\n  description_pro: item.json.pro?.description_pro || null,\n  description_kids: item.json.kids?.description_kids || null,\n  sessions_json: typeof item.json.sessions_json === 'string' ? item.json.sessions_json : JSON.stringify(item.json.sessions_json),\n  published: true,\n  import_batch_ts: new Date().toISOString()\n})) }}",
      "analysis": "Les 4 champs CityCrunch sont EXPLICITEMENT pr√©sents dans le payload. √Ä chaque upsert, si item.json.pro?.title_pro est null ou diff√©rent, le champ sera √©cras√© en DB."
    },

    "node_config_http_upsert": {
      "description": "Configuration compl√®te du n≈ìud d'upsert gd_stays",
      "node_name": "HTTP__UPSERT_GD_STAYS",
      "node_type": "n8n-nodes-base.httpRequest",
      "method": "POST",
      "url": "https://iirfvndgzutbxwfdwawu.supabase.co/rest/v1/gd_stays",
      "query_parameters": {
        "on_conflict": "source_url"
      },
      "headers": {
        "apikey": "{{ $credentials.supabase.serviceRoleKey }}",
        "Authorization": "Bearer {{ $credentials.supabase.serviceRoleKey }}",
        "Content-Type": "application/json",
        "Prefer": "resolution=merge-duplicates,return=representation"
      },
      "body_content_type": "json",
      "split_into_items": false
    }
  },

  "risk_assessment": {
    "overall_risk": "CRITIQUE",
    "risk_factors": [
      {
        "factor": "Champs CityCrunch inclus dans payload n8n",
        "severity": "CRITICAL",
        "probability": "100%",
        "impact": "√âcrasement garanti √† chaque ex√©cution"
      },
      {
        "factor": "Strat√©gie merge-duplicates (UPDATE ALL)",
        "severity": "CRITICAL",
        "probability": "100%",
        "impact": "Aucune protection au niveau DB"
      },
      {
        "factor": "Aucune reformulation LLM dans n8n",
        "severity": "HIGH",
        "probability": "100%",
        "impact": "Textes bruts UFOVAL au lieu de textes CityCrunch reformul√©s"
      },
      {
        "factor": "Workflow quotidien automatique",
        "severity": "HIGH",
        "probability": "Quotidien √† 02:00 (√† confirmer)",
        "impact": "R√©gression silencieuse chaque nuit"
      }
    ],
    "affected_fields": [
      "title_pro",
      "title_kids",
      "description_pro",
      "description_kids"
    ],
    "safe_fields": [
      "source_url",
      "slug",
      "title (√©cras√© mais moins critique car fallback)",
      "sessions_json",
      "published",
      "import_batch_ts"
    ]
  },

  "no_regression_solution": {
    "chosen_option": "OPT_A_REMOVE_FIELDS_FROM_UPSERT",
    "rationale": "Solution la plus s√ªre, la plus simple √† impl√©menter, et qui garantit 0% de risque d'√©crasement des champs CityCrunch.",
    "implementation_effort": "5 minutes (modifier 4 lignes de code dans n8n)",
    "regression_risk": "0% (les champs ne sont jamais touch√©s par n8n)",
    "performance_impact": "Aucun (m√™me nombre de requ√™tes)",

    "detailed_solution": {
      "step_1": {
        "action": "Ouvrir le workflow n8n",
        "url": "https://n8n.srv1307641.hstgr.cloud/workflow/kG6OASM4PxZaBt9H",
        "node_to_edit": "HTTP__UPSERT_GD_STAYS"
      },

      "step_2": {
        "action": "Modifier le bodyExpression",
        "current_code": "={{ $input.all().map(item => ({\n  source_url: item.json.source_url,\n  slug: item.json.slug || item.json.source_url.split('/').pop().replace(/[^a-z0-9-]/gi, '-').toLowerCase(),\n  title: item.json.pro?.title_pro || item.json.kids?.title_kids || 'Sans titre',\n  title_pro: item.json.pro?.title_pro,\n  title_kids: item.json.kids?.title_kids,\n  description_pro: item.json.pro?.description_pro || null,\n  description_kids: item.json.kids?.description_kids || null,\n  sessions_json: typeof item.json.sessions_json === 'string' ? item.json.sessions_json : JSON.stringify(item.json.sessions_json),\n  published: true,\n  import_batch_ts: new Date().toISOString()\n})) }}",
        "new_code": "={{ $input.all().map(item => ({\n  source_url: item.json.source_url,\n  slug: item.json.slug || item.json.source_url.split('/').pop().replace(/[^a-z0-9-]/gi, '-').toLowerCase(),\n  title: item.json.pro?.title_pro || item.json.kids?.title_kids || 'Sans titre',\n  sessions_json: typeof item.json.sessions_json === 'string' ? item.json.sessions_json : JSON.stringify(item.json.sessions_json),\n  published: true,\n  import_batch_ts: new Date().toISOString()\n})) }}",
        "changes": [
          "‚ùå RETIRER: title_pro: item.json.pro?.title_pro,",
          "‚ùå RETIRER: title_kids: item.json.kids?.title_kids,",
          "‚ùå RETIRER: description_pro: item.json.pro?.description_pro || null,",
          "‚ùå RETIRER: description_kids: item.json.kids?.description_kids || null,"
        ],
        "result": "n8n n'enverra JAMAIS ces champs dans le payload ‚Üí Supabase ne les touchera JAMAIS"
      },

      "step_3": {
        "action": "Modifier la strat√©gie d'upsert Supabase (optionnel mais recommand√©)",
        "current_header": "Prefer: resolution=merge-duplicates,return=representation",
        "new_header": "Prefer: resolution=merge-duplicates,return=representation",
        "note": "Garder merge-duplicates est OK car les champs CityCrunch ne sont plus dans le payload. Mais on pourrait aussi utiliser 'resolution=ignore-duplicates' pour ne PAS mettre √† jour les stays existants (seulement ins√©rer les nouveaux).",
        "alternative_strategy": {
          "header": "Prefer: resolution=ignore-duplicates,return=representation",
          "behavior": "INSERT uniquement les nouveaux stays (ignore les duplicates bas√©s sur source_url)",
          "use_case": "Si vous voulez FIGER les stays une fois cr√©√©s et ne jamais les mettre √† jour via n8n"
        }
      },

      "step_4": {
        "action": "Sauvegarder et tester",
        "checklist": [
          "‚òê Sauvegarder le workflow (Ctrl+S)",
          "‚òê Tester avec 'Execute Workflow' en mode manuel",
          "‚òê V√©rifier dans Supabase que les stays existants conservent leurs title_pro/title_kids",
          "‚òê V√©rifier que les nouveaux stays ont title_pro/title_kids = NULL (normal)",
          "‚òê Confirmer que sessions_json, source_url, slug sont bien mis √† jour"
        ]
      }
    }
  },

  "alternative_solutions_rejected": {
    "OPT_B_DB_LEVEL_GUARD": {
      "description": "Cr√©er une RPC/upsert custom c√¥t√© Supabase qui n'update CityCrunch QUE si NULL (COALESCE)",
      "pros": [
        "Protection au niveau DB (plus robuste)",
        "Permet de pr√©-remplir les champs CityCrunch via n8n si besoin"
      ],
      "cons": [
        "Plus complexe √† impl√©menter (SQL function + RPC)",
        "N√©cessite de modifier l'URL du n≈ìud n8n pour appeler la RPC",
        "Maintenance suppl√©mentaire (fonction SQL √† maintenir)",
        "Overhead de performance (fonction SQL ex√©cut√©e √† chaque upsert)"
      ],
      "rejected_reason": "Trop complexe pour le b√©n√©fice. OPT_A est plus simple et tout aussi efficace."
    },

    "OPT_C_TWO_TABLE_STRATEGY": {
      "description": "Stocker la source brute dans colonnes 'source_*' et garder CityCrunch dans colonnes s√©par√©es non touch√©es par n8n",
      "pros": [
        "S√©paration claire des donn√©es source vs reformul√©es",
        "Permet de comparer source UFOVAL vs texte CityCrunch",
        "Historisation possible (savoir quand la source a chang√©)"
      ],
      "cons": [
        "N√©cessite une migration de sch√©ma DB (ajouter colonnes source_title_pro, etc.)",
        "Double stockage des textes (redondance)",
        "Modification de l'app front pour lire les bonnes colonnes",
        "R√©gression potentielle sur l'app existante"
      ],
      "rejected_reason": "Trop invasif. N√©cessite des changements DB + app. OPT_A est non-r√©gressif."
    }
  },

  "sql_verification_queries": {
    "description": "Requ√™tes √† ex√©cuter dans Supabase SQL Editor pour v√©rifier l'√©tat avant/apr√®s fix",
    "before_fix": [
      {
        "query": "SELECT NOW() AS current_timestamp;",
        "purpose": "V√©rifier l'heure serveur Supabase"
      },
      {
        "query": "SELECT MAX(import_batch_ts) AS last_import_ts FROM public.gd_stays;",
        "purpose": "Derni√®re mise √† jour n8n"
      },
      {
        "query": "SELECT COUNT(*)::INT AS updated_last_24h FROM public.gd_stays WHERE import_batch_ts > NOW() - INTERVAL '24 hours';",
        "purpose": "Nombre de stays mis √† jour dans les derni√®res 24h"
      },
      {
        "query": "SELECT\n  SUM((title_pro IS NOT NULL)::INT)::INT AS title_pro_filled,\n  SUM((title_kids IS NOT NULL)::INT)::INT AS title_kids_filled,\n  SUM((description_pro IS NOT NULL)::INT)::INT AS description_pro_filled,\n  SUM((description_kids IS NOT NULL)::INT)::INT AS description_kids_filled,\n  COUNT(*)::INT AS total_stays\nFROM public.gd_stays;",
        "purpose": "Statistiques champs CityCrunch (combien de stays ont ces champs remplis)"
      },
      {
        "query": "SELECT slug, title, title_pro, title_kids, LEFT(description_pro, 50) AS desc_pro_preview, import_batch_ts\nFROM public.gd_stays\nWHERE title_pro IS NOT NULL OR title_kids IS NOT NULL\nORDER BY import_batch_ts DESC\nLIMIT 5;",
        "purpose": "√âchantillon de stays avec champs CityCrunch remplis"
      }
    ],

    "after_fix": [
      {
        "query": "-- Ex√©cuter le workflow n8n manuellement (1 stay test)\n-- Puis v√©rifier que les champs CityCrunch n'ont PAS √©t√© √©cras√©s :\nSELECT slug, title, title_pro, title_kids, description_pro, import_batch_ts\nFROM public.gd_stays\nWHERE slug = 'SLUG_DU_STAY_TEST'\nORDER BY import_batch_ts DESC\nLIMIT 1;",
        "purpose": "V√©rifier qu'un stay existant CONSERVE ses champs CityCrunch apr√®s re-upsert"
      },
      {
        "query": "-- V√©rifier qu'un NOUVEAU stay cr√©√© par n8n a bien title_pro/title_kids NULL :\nSELECT slug, title, title_pro, title_kids, description_pro, import_batch_ts\nFROM public.gd_stays\nWHERE import_batch_ts > NOW() - INTERVAL '5 minutes'\nORDER BY import_batch_ts DESC\nLIMIT 3;",
        "purpose": "V√©rifier que les nouveaux stays n'ont PAS de champs CityCrunch (NULL)"
      }
    ]
  },

  "definition_of_done": {
    "checklist": [
      "‚úÖ On sait exactement ce que n8n met √† jour √† 02:00 (tables + champs + strat√©gie conflit)",
      "‚úÖ On sait que CityCrunch PEUT √äTRE √©cras√© (risque confirm√© √† 100%)",
      "‚úÖ Une protection est mise en place (OPT_A: retirer champs du payload)",
      "‚òê Le code n8n a √©t√© modifi√© (bodyExpression du n≈ìud HTTP__UPSERT_GD_STAYS)",
      "‚òê Le workflow a √©t√© test√© en mode manuel (Execute Workflow)",
      "‚òê V√©rification SQL confirme que les champs CityCrunch sont pr√©serv√©s",
      "‚òê Documentation mise √† jour (ce fichier JSON + commentaire dans n8n node)"
    ],
    "success_criteria": [
      "Aucun champ CityCrunch n'est pr√©sent dans le payload n8n",
      "Les stays existants conservent leurs title_pro/title_kids apr√®s upsert",
      "Les nouveaux stays ont title_pro/title_kids = NULL (remplis ensuite par l'app ou LLM)",
      "Le workflow n8n continue de fonctionner sans erreur"
    ]
  },

  "next_steps": {
    "immediate": [
      "1. URGENT: Modifier le workflow n8n AVANT la prochaine ex√©cution automatique √† 02:00",
      "2. Retirer les 4 lignes (title_pro, title_kids, description_pro, description_kids) du payload",
      "3. Sauvegarder et tester le workflow en mode manuel"
    ],
    "short_term": [
      "4. V√©rifier le planning du workflow (Settings > Schedule) pour confirmer l'heure 02:00",
      "5. Ajouter un commentaire dans le n≈ìud n8n: 'IMPORTANT: Ne PAS inclure title_pro/title_kids/description_pro/description_kids dans ce payload (champs g√©r√©s par CityCrunch/LLM)'",
      "6. Ex√©cuter les requ√™tes SQL de v√©rification pour documenter l'√©tat avant/apr√®s"
    ],
    "long_term": [
      "7. D√©cider comment les champs CityCrunch seront remplis (LLM dans l'app ? Workflow n8n s√©par√© avec reformulation ?)",
      "8. Si besoin de reformulation LLM dans n8n: cr√©er un NOUVEAU workflow s√©par√© qui lit gd_stays, reformule avec LLM, et met √† jour UNIQUEMENT les champs CityCrunch (sans toucher aux autres champs)",
      "9. Documenter la strat√©gie de contenu (quand utiliser title vs title_pro vs title_kids)"
    ]
  },

  "contact_info": {
    "n8n_instance": "https://n8n.srv1307641.hstgr.cloud",
    "supabase_project": "https://supabase.com/dashboard/project/iirfvndgzutbxwfdwawu",
    "supabase_project_id": "iirfvndgzutbxwfdwawu",
    "support": "Si besoin d'aide: ouvrir l'interface n8n et inspecter le n≈ìud HTTP__UPSERT_GD_STAYS"
  }
}
