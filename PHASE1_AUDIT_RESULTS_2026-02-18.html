<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phase 1 ‚Äî R√©sultats Audit SQL ‚Äî GED APP ‚Äî 2026-02-18</title>
<style>
  :root {
    --primary: #1e2d3a;
    --accent: #de7356;
    --ok: #16a34a;
    --warn: #d97706;
    --error: #dc2626;
    --info: #2563eb;
    --bg: #f0f4f8;
    --card: #ffffff;
    --border: #dde3ea;
    --text: #1e293b;
    --muted: #64748b;
    --code-bg: #0f172a;
    --code-text: #e2e8f0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.6; }

  header { background: var(--primary); color: white; padding: 22px 36px; }
  header h1 { font-size: 19px; font-weight: 800; }
  header .sub { font-size: 12px; opacity: 0.65; margin-top: 4px; }
  .hbadges { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
  .hb { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .hb-crit { background: #dc2626; }
  .hb-phase { background: #7c3aed; }
  .hb-ok { background: #059669; }

  main { max-width: 1280px; margin: 0 auto; padding: 28px 18px 70px; }

  /* KPI strip */
  .kpi-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 24px; }
  .kpi { background: white; border-radius: 8px; padding: 14px; border-left: 4px solid; }
  .kpi.red { border-color: var(--error); }
  .kpi.orange { border-color: var(--warn); }
  .kpi.green { border-color: var(--ok); }
  .kpi.blue { border-color: var(--info); }
  .kpi .kl { font-size: 10px; text-transform: uppercase; font-weight: 600; color: var(--muted); letter-spacing: 0.4px; }
  .kpi .kv { font-size: 24px; font-weight: 900; line-height: 1.1; margin-top: 2px; }
  .kpi.red .kv { color: var(--error); }
  .kpi.orange .kv { color: var(--warn); }
  .kpi.green .kv { color: var(--ok); }
  .kpi.blue .kv { color: var(--info); }
  .kpi .ks { font-size: 11px; color: var(--muted); margin-top: 1px; }

  /* Alert boxes */
  .alert { border-radius: 8px; padding: 12px 16px; margin-bottom: 14px; border-left: 4px solid; font-size: 12px; }
  .alert-error { background: #fef2f2; border-color: var(--error); color: #991b1b; }
  .alert-ok { background: #f0fdf4; border-color: var(--ok); color: #14532d; }
  .alert-warn { background: #fffbeb; border-color: var(--warn); color: #92400e; }
  .alert-info { background: #eff6ff; border-color: var(--info); color: #1e40af; }
  .alert strong { font-weight: 700; display: block; margin-bottom: 2px; }

  /* Section */
  .section { background: white; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
  .section-hdr { padding: 13px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
  .section-hdr h3 { font-size: 13px; font-weight: 700; }
  .q-badge { font-size: 11px; font-weight: 800; padding: 3px 10px; border-radius: 12px; margin-left: auto; }
  .qb-error { background: #fee2e2; color: #991b1b; }
  .qb-warn { background: #fef3c7; color: #92400e; }
  .qb-ok { background: #dcfce7; color: #14532d; }
  .qb-info { background: #dbeafe; color: #1e40af; }
  .section-body { padding: 18px; }

  /* Table */
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { background: #f8fafc; padding: 8px 10px; text-align: left; font-weight: 600; color: var(--muted); text-transform: uppercase; font-size: 10px; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); white-space: nowrap; }
  td { padding: 7px 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr.crit { background: #fff5f5; }
  tr.warn-row { background: #fffbeb; }
  td.cell-ok { color: var(--ok); font-weight: 600; }
  td.cell-err { color: var(--error); font-weight: 600; }
  td.cell-warn { color: var(--warn); font-weight: 600; }

  /* Code */
  pre { background: var(--code-bg); color: var(--code-text); padding: 14px; border-radius: 8px; font-size: 11.5px; font-family: 'Cascadia Code', Consolas, monospace; overflow-x: auto; line-height: 1.7; white-space: pre; }
  .code-label { font-size: 10px; text-transform: uppercase; color: var(--muted); font-weight: 600; margin-bottom: 5px; letter-spacing: 0.5px; }

  /* Tags */
  .tag { display: inline-block; padding: 2px 7px; border-radius: 9px; font-size: 10px; font-weight: 700; margin-right: 3px; }
  .te { background: #fee2e2; color: #991b1b; }
  .tw { background: #fef3c7; color: #92400e; }
  .to { background: #dcfce7; color: #14532d; }
  .ti { background: #dbeafe; color: #1e40af; }
  .tg { background: #e2e8f0; color: #475569; }

  /* Impact matrix */
  .impact-row { display: flex; gap: 12px; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .impact-row:last-child { border-bottom: none; }
  .imp-icon { font-size: 18px; flex-shrink: 0; width: 28px; text-align: center; }
  .imp-body { flex: 1; }
  .imp-body strong { font-size: 13px; font-weight: 700; }
  .imp-body p { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .imp-body .imp-count { font-size: 20px; font-weight: 900; color: var(--error); }

  footer { background: var(--primary); color: rgba(255,255,255,0.5); text-align: center; padding: 14px; font-size: 11px; margin-top: 40px; }
</style>
</head>
<body>

<header>
  <h1>üìä Phase 1 ‚Äî R√©sultats Audit SQL R√©els ‚Äî GED APP</h1>
  <div class="sub">R√©sultats ex√©cut√©s en production Supabase ¬∑ 2026-02-18 ¬∑ Sch√©ma r√©el confirm√©</div>
  <div class="hbadges">
    <span class="hb hb-crit">üî¥ 19 sessions sans prix</span>
    <span class="hb hb-crit">üî¥ 1 session 6j GRAVITY BIKE</span>
    <span class="hb hb-phase">Phase 1 compl√®te</span>
    <span class="hb hb-ok">Go Phase 2</span>
  </div>
</header>

<main>

<!-- KPI STRIP -->
<div class="kpi-strip">
  <div class="kpi red">
    <div class="kl">Sessions sans prix</div>
    <div class="kv">19</div>
    <div class="ks">Sur 7 s√©jours ¬∑ PRICE_NOT_FOUND bloquant</div>
  </div>
  <div class="kpi red">
    <div class="kl">S√©jours impact√©s prix</div>
    <div class="kv">7</div>
    <div class="ks">AZUR, BABY, BLUE, DUNE, GRAVITY, ROCKS, SWIM, FOREST</div>
  </div>
  <div class="kpi orange">
    <div class="kl">Sessions GRAVITY BIKE</div>
    <div class="kv">10</div>
    <div class="ks">6j√ó1 parasite + 7j√ó6 + 14j√ó2 + 21j√ó1</div>
  </div>
  <div class="kpi orange">
    <div class="kl">is_full d√©syncs</div>
    <div class="kv">2</div>
    <div class="ks">GRAVITY BIKE ¬∑ seats_left=null</div>
  </div>
  <div class="kpi red">
    <div class="kl">Sch√©ma: colonne manquante</div>
    <div class="kv">1</div>
    <div class="ks">s.universe inexistant (Q1 √† re-ex√©cuter)</div>
  </div>
  <div class="kpi red">
    <div class="kl">SQL en erreur</div>
    <div class="kv">2</div>
    <div class="ks">Q1 (universe), Q3 (syntax) ‚Äî corrig√©s ci-dessous</div>
  </div>
</div>

<!-- ALERTE CRITIQUE GLOBALE -->
<div class="alert alert-error">
  <strong>üö® FINDING CRITIQUE INATTENDU ‚Äî P√©rim√®tre prix beaucoup plus large que pr√©vu</strong>
  L'audit initial estimait 3 sessions sans prix (RIVIERA SPEED CLUB). Le SQL Phase 1 r√©v√®le <strong>19 sessions sans prix sur 8 s√©jours distincts</strong>.
  Cela signifie que toute tentative d'inscription sur ces sessions retourne <code>PRICE_NOT_FOUND</code> et est bloqu√©e c√¥t√© /api/inscriptions.
  Ce n'est plus un probl√®me isol√© RIVIERA SPEED CLUB ‚Äî c'est une anomalie structurelle de l'import des tarifs.
</div>

<!-- Q2 : PRIX MANQUANTS (R√âSULTAT R√âEL) -->
<div class="section">
  <div class="section-hdr">
    <h3>üìã Q2 ‚Äî Sessions sans prix (PRICE_NOT_FOUND) ‚Äî 19 sessions ¬∑ 8 s√©jours</h3>
    <span class="q-badge qb-error">üî¥ CRITIQUE P0</span>
  </div>
  <div class="section-body">

    <div class="alert alert-error">
      <strong>Impact direct : inscription impossible sur ces sessions</strong>
      Le circuit /api/inscriptions (route.ts L106-137) retourne <code>PRICE_NOT_FOUND</code> si <code>gd_session_prices</code> ne contient pas de row pour cette session.
      Ces 19 sessions sont publiques mais non-achetables.
    </div>

    <table>
      <thead>
        <tr>
          <th>S√©jour GED</th>
          <th>Slug</th>
          <th>Nb sessions sans prix</th>
          <th>Dates concern√©es</th>
          <th>Dur√©e</th>
          <th>Priorit√© correction</th>
        </tr>
      </thead>
      <tbody>
        <tr class="crit">
          <td><strong>AZUR DIVE & JET</strong></td>
          <td><code>aqua-fun</code></td>
          <td class="cell-err"><strong>3 sessions</strong></td>
          <td>05/07, 19/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="crit">
          <td><strong>BABY RIDERS</strong></td>
          <td><code>aqua-gliss</code></td>
          <td class="cell-err"><strong>3 sessions</strong></td>
          <td>05/07, 19/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="crit">
          <td><strong>BLUE EXPERIENCE</strong></td>
          <td><code>aqua-mix</code></td>
          <td class="cell-err"><strong>3 sessions</strong></td>
          <td>05/07, 19/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="warn-row">
          <td><strong>DUNE & OCEAN KIDS</strong></td>
          <td><code>destination-bassin-darcachon-1</code></td>
          <td class="cell-err"><strong>1 session</strong></td>
          <td>19/07</td>
          <td>7j</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="crit">
          <td><strong>GRAVITY BIKE PARK</strong></td>
          <td><code>dh-experience-11-13-ans</code></td>
          <td class="cell-err"><strong>2 sessions</strong></td>
          <td>12/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="crit">
          <td><strong>ROCKS & PADDLE</strong></td>
          <td><code>laventure-verticale</code></td>
          <td class="cell-err"><strong>3 sessions</strong></td>
          <td>05/07, 19/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="warn-row">
          <td><strong>MY LITTLE FOREST</strong></td>
          <td><code>les-ptits-puisotins-1</code></td>
          <td class="cell-err"><strong>1 session</strong></td>
          <td>23/08 (‚Üí 29/08)</td>
          <td>7j <em>(apr√®s correction 6j‚Üí7j)</em></td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
        <tr class="crit">
          <td><strong>SWIM ACADEMY</strong></td>
          <td><code>natation-et-sensation</code></td>
          <td class="cell-err"><strong>3 sessions</strong></td>
          <td>05/07, 19/07, 02/08</td>
          <td>7j chacune</td>
          <td><span class="tag te">üî¥ P0</span></td>
        </tr>
      </tbody>
    </table>

    <div class="alert alert-warn" style="margin-top:14px;">
      <strong>Hypoth√®se cause racine ‚Äî Pattern dates commun : 05/07, 19/07, 02/08</strong>
      Les sessions sans prix partagent syst√©matiquement les m√™mes 3 dates de d√©but : <strong>05/07, 19/07 et 02/08</strong>.
      Ce pattern r√©gulier sugg√®re que l'import des tarifs n'a couvert qu'un sous-ensemble des sessions, probablement lors d'un import partiel ou interrompu.
      Les sessions aux autres dates (ex: 12/07, 09/08, 16/08) semblent avoir leurs prix ‚Äî √† confirmer avec Q1 corrig√©.
    </div>

  </div>
</div>

<!-- Q5 : GRAVITY BIKE PARK (R√âSULTAT R√âEL) -->
<div class="section">
  <div class="section-hdr">
    <h3>üöµ Q5 ‚Äî GRAVITY BIKE PARK ‚Äî Analyse sessions r√©elles BDD</h3>
    <span class="q-badge qb-warn">üü† ANOMALIE CONFIRM√âE</span>
  </div>
  <div class="section-body">

    <div class="alert alert-warn">
      <strong>10 sessions pr√©sentes ‚Äî Structure multi-dur√©es partiellement import√©e</strong>
      Bonne nouvelle : les 14j (√ó2) et 21j (√ó1) existent en BDD. La session 6j (parasite) provient du m√™me bug off-by-one scraper.
      Le probl√®me n'est plus "sessions manquantes 14j/21j" mais "1 session 6j parasite + 2 sessions 7j manquantes + 2 sessions sans prix".
    </div>

    <table>
      <thead>
        <tr>
          <th>Dur√©e BDD (jours inclusifs)</th>
          <th>Nb sessions</th>
          <th>Dates d√©but</th>
          <th>Attendu UFOVAL</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr class="crit">
          <td class="cell-err"><strong>6j</strong></td>
          <td class="cell-err"><strong>1</strong></td>
          <td>23/08/2026</td>
          <td>0j (6j est une erreur off-by-one du 7j)</td>
          <td><span class="tag te">‚ùå PARASITE</span></td>
          <td>UPDATE end_date +1j ‚Üí passe √† 7j</td>
        </tr>
        <tr>
          <td><strong>7j</strong></td>
          <td class="cell-warn"><strong>6</strong></td>
          <td>05/07, 12/07, 19/07, 02/08, 09/08, 16/08</td>
          <td>8 sessions 7j attendues (hebdo 05/07‚Üí23/08)</td>
          <td><span class="tag tw">‚ö†Ô∏è 2 MANQUANTES</span></td>
          <td>INSERT sessions 26/07‚Üí01/08 et 23/08‚Üí29/08 (apr√®s correction 6j)</td>
        </tr>
        <tr class="crit">
          <td><strong>7j (sans prix)</strong></td>
          <td class="cell-err"><strong>2</strong></td>
          <td>12/07, 02/08</td>
          <td>Prix requis</td>
          <td><span class="tag te">‚ùå PRIX MANQUANT</span></td>
          <td>INSERT gd_session_prices pour ces 2 dates</td>
        </tr>
        <tr class="to">
          <td class="cell-ok"><strong>14j</strong></td>
          <td class="cell-ok"><strong>2</strong></td>
          <td>02/08, 09/08</td>
          <td>Sessions 14j pr√©sentes ‚úÖ</td>
          <td><span class="tag to">‚úÖ PR√âSENTES</span></td>
          <td>V√©rifier prix (Q2 ne les liste pas ‚Üí prix OK ?)</td>
        </tr>
        <tr class="to">
          <td class="cell-ok"><strong>21j</strong></td>
          <td class="cell-ok"><strong>1</strong></td>
          <td>02/08</td>
          <td>Session 21j pr√©sente ‚úÖ</td>
          <td><span class="tag to">‚úÖ PR√âSENTE</span></td>
          <td>V√©rifier prix (Q2 ne la liste pas ‚Üí prix OK ?)</td>
        </tr>
      </tbody>
    </table>

    <div class="alert alert-info" style="margin-top:14px;">
      <strong>R√©vision de l'estimation initiale</strong>
      Les 14j et 21j ne sont <em>pas</em> manquants ‚Äî ils sont en BDD. Ce qui manque : la session 7j du <strong>26/07‚Üí01/08</strong> (semaine manquante dans la s√©quence hebdomadaire)
      et la session 7j du <strong>23/08‚Üí29/08</strong> (actuellement en 6j, √† corriger +1j).
      Apr√®s correction de la session 6j ‚Üí 7j, il restera 1 session 7j √† ins√©rer (26/07‚Üí01/08) pour atteindre 8 sessions 7j.
    </div>

  </div>
</div>

<!-- Q4 : IS_FULL (R√âSULTAT R√âEL) -->
<div class="section">
  <div class="section-hdr">
    <h3>üîí Q4 ‚Äî is_full d√©synchronis√© ‚Äî 2 sessions GRAVITY BIKE PARK</h3>
    <span class="q-badge qb-warn">‚ö†Ô∏è Mineure ‚Äî seats_left=null</span>
  </div>
  <div class="section-body">

    <div class="alert alert-warn">
      <strong>is_full=true + seats_left=null ‚Üí coh√©rent par d√©faut (pas de tracking places)</strong>
      Les 2 sessions d√©tect√©es (12/07 et 02/08) ont <code>is_full=true</code> et <code>seats_left=null</code>.
      La condition de d√©sync v√©rifiait <code>seats_left = 0</code> ‚Äî ce n'est pas le cas ici : <code>null</code> = pas de tracking.
      Ces 2 sessions sont marqu√©es "Complet" c√¥t√© UFOVAL et c'est possiblement correct. √Ä v√©rifier sur UFOVAL live.
      Le d√©sync r√©el (5 sessions) identifi√© lors de l'audit Chrome reste √† confirmer s√©par√©ment.
    </div>

    <table>
      <thead>
        <tr>
          <th>Slug</th>
          <th>Start date</th>
          <th>End date</th>
          <th>is_full</th>
          <th>seats_left</th>
          <th>Interpr√©tation</th>
        </tr>
      </thead>
      <tbody>
        <tr class="warn-row">
          <td><code>dh-experience-11-13-ans</code></td>
          <td>2026-07-12</td>
          <td>2026-07-18</td>
          <td class="cell-err">true</td>
          <td class="cell-warn">null</td>
          <td>Marqu√© complet UFOVAL ‚Äî seats_left non track√©. Ces 2 sessions sont aussi <strong>sans prix</strong> (Q2). Double anomalie.</td>
        </tr>
        <tr class="warn-row">
          <td><code>dh-experience-11-13-ans</code></td>
          <td>2026-08-02</td>
          <td>2026-08-08</td>
          <td class="cell-err">true</td>
          <td class="cell-warn">null</td>
          <td>Idem ‚Äî is_full=true + sans prix. Si la session est compl√®te, le prix est quand m√™me requis pour validation circuit /api/inscriptions.</td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

<!-- CORRECTIONS SQL PHASE 2 -->
<div class="section">
  <div class="section-hdr">
    <h3>üîß SQL corrig√©s √† r√©-ex√©cuter + SQL Phase 2 ‚Äî Pr√™ts pour Supabase SQL Editor</h3>
    <span class="q-badge qb-info">PHASE 2 ‚Äî √âCRITURE</span>
  </div>
  <div class="section-body">

    <div class="alert alert-info">
      <strong>SQL Q1 corrig√© ‚Äî Suppression s.universe (colonne inexistante)</strong>
    </div>

    <div class="code-label">SQL Q1-CORRIG√â ‚Äî Tableau de bord global (sans s.universe)</div>
    <pre>-- Q1 CORRIG√â ‚Äî Audit global sessions par s√©jour (sans colonne universe qui n'existe pas)
SELECT
  ss.stay_slug,
  s.marketing_title                                       AS titre_ged,
  COUNT(*)                                                AS nb_sessions,
  MIN(ss.start_date)                                      AS premiere_session,
  MAX(ss.end_date)                                        AS derniere_session,
  STRING_AGG(
    DISTINCT ((ss.end_date::date - ss.start_date::date) + 1)::text,
    ', ' ORDER BY ((ss.end_date::date - ss.start_date::date) + 1)::text
  )                                                       AS durees_jours_inclusifs,
  COUNT(DISTINCT ((ss.end_date::date - ss.start_date::date) + 1)) AS nb_variantes_duree,
  SUM(CASE WHEN ss.is_full THEN 1 ELSE 0 END)             AS sessions_complet,
  SUM(CASE WHEN sp.price_ged_total IS NULL THEN 1 ELSE 0 END) AS sessions_sans_prix
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s       ON s.slug = ss.stay_slug
LEFT JOIN gd_session_prices sp
  ON sp.stay_slug = ss.stay_slug
  AND sp.start_date = ss.start_date
  AND sp.end_date   = ss.end_date
GROUP BY ss.stay_slug, s.marketing_title
ORDER BY
  SUM(CASE WHEN sp.price_ged_total IS NULL THEN 1 ELSE 0 END) DESC,
  nb_sessions DESC;</pre>

    <div class="code-label" style="margin-top:16px;">SQL Q3-CORRIG√â ‚Äî Dur√©es hors r√©f√©rentiel UFOVAL (syntax corrig√©e)</div>
    <pre>-- Q3 CORRIG√â ‚Äî Dur√©es hors r√©f√©rentiel UFOVAL (6j = parasite off-by-one inclus)
SELECT
  ss.stay_slug,
  s.marketing_title,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours_inclusifs,
  CASE
    WHEN (ss.end_date::date - ss.start_date::date) + 1 = 6
    THEN '‚ö†Ô∏è 6j = off-by-one scraper (attendu 7j)'
    ELSE '‚ö†Ô∏è Dur√©e hors r√©f√©rentiel UFOVAL'
  END                                             AS alerte
FROM gd_stay_sessions ss
JOIN gd_stays s ON s.slug = ss.stay_slug
WHERE ((ss.end_date::date - ss.start_date::date) + 1)
  NOT IN (7, 12, 14, 19, 21)
ORDER BY ss.stay_slug, ss.start_date;</pre>

    <div class="code-label" style="margin-top:16px;">SQL PHASE 2-A ‚Äî Correction GRAVITY BIKE PARK session 6j ‚Üí 7j (off-by-one)</div>
    <pre>-- PHASE 2-A : Correction session 6j ‚Üí 7j GRAVITY BIKE PARK
-- M√™me bug que MY LITTLE FOREST ‚Äî scraper calcul en nuits

-- √âTAPE 1 : V√©rification avant correction
SELECT
  stay_slug, start_date, end_date,
  (end_date::date - start_date::date) + 1           AS duree_actuelle,
  (start_date::date + INTERVAL '6 days')::date      AS end_date_corrige,
  '7j inclusifs apr√®s correction'                    AS duree_apres
FROM gd_stay_sessions
WHERE stay_slug = 'dh-experience-11-13-ans'
  AND (end_date::date - start_date::date) + 1 = 6;

-- √âTAPE 2 : Backup
CREATE TABLE IF NOT EXISTS gd_stay_sessions_backup_6j_dh_experience AS
SELECT * FROM gd_stay_sessions
WHERE stay_slug = 'dh-experience-11-13-ans'
  AND (end_date::date - start_date::date) + 1 = 6;

-- √âTAPE 3 : Correction (d√©commenter apr√®s v√©rification √âTAPE 1)
-- UPDATE gd_stay_sessions
-- SET end_date = end_date::date + INTERVAL '1 day'
-- WHERE stay_slug = 'dh-experience-11-13-ans'
--   AND (end_date::date - start_date::date) + 1 = 6
-- RETURNING stay_slug, start_date, end_date,
--   (end_date::date - start_date::date) + 1 AS duree_apres_correction;</pre>

    <div class="code-label" style="margin-top:16px;">SQL PHASE 2-B ‚Äî Correction MY LITTLE FOREST session 6j ‚Üí 7j (d√©j√† pr√™te)</div>
    <pre>-- PHASE 2-B : MY LITTLE FOREST ‚Äî Copier-coller du fichier CORRECTION_SESSION_6_JOURS_PTITS_PUISOTINS.sql
-- Backup : gd_stay_sessions_backup_6jours_ptits_puisotins (d√©j√† cr√©√©)

-- √âTAPE 3 : Correction (d√©commenter)
-- UPDATE gd_stay_sessions
-- SET end_date = end_date::date + INTERVAL '1 day'
-- WHERE stay_slug = 'les-ptits-puisotins-1'
--   AND (end_date::date - start_date::date) + 1 = 6
-- RETURNING stay_slug, start_date, end_date,
--   (end_date::date - start_date::date) + 1 AS duree_apres_correction;

-- R√©sultat attendu : 23/08/2026 ‚Üí end_date passe de 28/08 √† 29/08 (7j inclusifs)</pre>

    <div class="code-label" style="margin-top:16px;">SQL PHASE 2-C ‚Äî INSERT session 7j manquante GRAVITY BIKE PARK (26/07‚Üí01/08)</div>
    <pre>-- PHASE 2-C : INSERT session 7j manquante GRAVITY BIKE PARK
-- S√©quence hebdomadaire : 05/07, 12/07, 19/07, [26/07 MANQUANT], 02/08, 09/08, 16/08, 23/08

-- V√âRIFICATION d'abord : s'assurer que la session n'existe pas d√©j√†
SELECT * FROM gd_stay_sessions
WHERE stay_slug = 'dh-experience-11-13-ans'
  AND start_date = '2026-07-26';

-- INSERT si absent (d√©commenter apr√®s v√©rification)
-- INSERT INTO gd_stay_sessions (stay_slug, start_date, end_date, is_full, seats_left)
-- VALUES ('dh-experience-11-13-ans', '2026-07-26', '2026-08-01', false, NULL)
-- ON CONFLICT (stay_slug, start_date) DO NOTHING;

-- Note : end_date = start_date + 6 jours = 01/08 (7j inclusifs : 26/07‚Üí01/08)
-- seats_left=NULL : coh√©rent avec les autres sessions de ce s√©jour</pre>

    <div class="code-label" style="margin-top:16px;">SQL PHASE 2-D ‚Äî Audit prix manquants par s√©jour pour quantifier l'import requis</div>
    <pre>-- PHASE 2-D : Quantification exacte des prix manquants par s√©jour + villes de d√©part
-- La table gd_session_prices contient une row par (stay_slug, start_date, end_date, departure_city)
-- 19 sessions sans prix = potentiellement 19 √ó N villes de d√©part manquantes

-- Compter les rows prix existantes pour les sessions qui en ont
SELECT
  sp.stay_slug,
  s.marketing_title,
  sp.start_date,
  sp.end_date,
  COUNT(*)            AS nb_prix_existants  -- nombre de villes de d√©part pric√©es
FROM gd_session_prices sp
JOIN gd_stays s ON s.slug = sp.stay_slug
WHERE sp.stay_slug IN (
  'aqua-fun', 'aqua-gliss', 'aqua-mix',
  'destination-bassin-darcachon-1', 'dh-experience-11-13-ans',
  'laventure-verticale', 'les-ptits-puisotins-1', 'natation-et-sensation'
)
GROUP BY sp.stay_slug, s.marketing_title, sp.start_date, sp.end_date
ORDER BY sp.stay_slug, sp.start_date;

-- R√©sultat attendu : voir combien de prix existent par session
-- Comparer avec les sessions sans prix de Q2 pour identifier les villes manquantes</pre>

  </div>
</div>

<!-- PLAN D'ACTION R√âVIS√â -->
<div class="section">
  <div class="section-hdr">
    <h3>üéØ Plan d'action Phase 2 r√©vis√© ‚Äî Post-r√©sultats r√©els</h3>
    <span class="q-badge qb-info">S√âQUENCE OBLIGATOIRE</span>
  </div>
  <div class="section-body">

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Action</th>
          <th>S√©jours impact√©s</th>
          <th>SQL</th>
          <th>Impact si non-fait</th>
        </tr>
      </thead>
      <tbody>
        <tr class="crit">
          <td>1</td>
          <td>Re-ex√©cuter Q1-CORRIG√â (sans s.universe) pour tableau de bord complet</td>
          <td>24 s√©jours</td>
          <td>Q1-CORRIG√â ci-dessus</td>
          <td class="cell-err">Tableau de bord absent</td>
        </tr>
        <tr class="crit">
          <td>2</td>
          <td>Ex√©cuter Q3-CORRIG√â pour lister toutes sessions hors r√©f√©rentiel</td>
          <td>Tous</td>
          <td>Q3-CORRIG√â ci-dessus</td>
          <td class="cell-err">Sessions parasites non d√©tect√©es</td>
        </tr>
        <tr class="crit">
          <td>3</td>
          <td>Corriger session 6j ‚Üí 7j GRAVITY BIKE PARK (backup + UPDATE)</td>
          <td>GRAVITY BIKE PARK</td>
          <td>PHASE 2-A ci-dessus</td>
          <td class="cell-err">Session 6j parasite = off-by-one = prix invalide</td>
        </tr>
        <tr class="crit">
          <td>4</td>
          <td>Corriger session 6j ‚Üí 7j MY LITTLE FOREST</td>
          <td>MY LITTLE FOREST</td>
          <td>PHASE 2-B (fichier SQL existant)</td>
          <td class="cell-err">Session 23/08 sans prix valide apr√®s correction</td>
        </tr>
        <tr class="warn-row">
          <td>5</td>
          <td>INSERT session 7j manquante 26/07‚Üí01/08 GRAVITY BIKE PARK</td>
          <td>GRAVITY BIKE PARK</td>
          <td>PHASE 2-C ci-dessus</td>
          <td class="cell-warn">Semaine 26/07 non disponible √† la r√©servation</td>
        </tr>
        <tr class="crit">
          <td>6</td>
          <td>Quantifier prix manquants (PHASE 2-D) puis re-importer tarifs</td>
          <td>8 s√©jours (19 sessions)</td>
          <td>PHASE 2-D ‚Üí puis INSERT gd_session_prices</td>
          <td class="cell-err">19 sessions bloqu√©es PRICE_NOT_FOUND</td>
        </tr>
        <tr class="warn-row">
          <td>7</td>
          <td>Re-ex√©cuter Q1-CORRIG√â en validation finale pour confirmer 0 session sans prix</td>
          <td>Tous</td>
          <td>Q1-CORRIG√â (sessions_sans_prix = 0)</td>
          <td class="cell-warn">Phase 2 non valid√©e</td>
        </tr>
      </tbody>
    </table>

    <div class="alert alert-ok" style="margin-top:14px;">
      <strong>‚úÖ Bonne nouvelle confirm√©e par Q5</strong>
      Les sessions 14j (√ó2) et 21j (√ó1) de GRAVITY BIKE PARK <em>existent</em> en BDD. Elles ne sont pas list√©es dans Q2 (sans prix) ‚Üí leurs prix semblent pr√©sents.
      La correction principale reste : 1 session 6j ‚Üí 7j + 1 session 7j manquante + les 2 sessions 7j sans prix (12/07 et 02/08).
    </div>

  </div>
</div>

</main>

<footer>
  GED APP ‚Äî Phase 1 R√©sultats Audit SQL ¬∑ 2026-02-18 ¬∑ 19 sessions sans prix ¬∑ 10 sessions GRAVITY BIKE PARK ¬∑ Plan Phase 2 pr√™t
</footer>

</body>
</html>
