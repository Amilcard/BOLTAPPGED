{
  "project": "GED_APP",
  "date": "2026-02-16",
  "mode": "ECONOMY_SECURE_NO_REGRESSION",
  "phase": "PRE_PRODUCTION_STABILIZATION",
  "branch": "work",
  "base_commit": "728d62e fix: apiVersion Stripe + types TS booking-flow/modal",

  "audit_summary": {
    "frontend_score": "6.5/10",
    "backend_risk": "MEDIUM-HIGH",
    "stripe_live": false,
    "campaign_live": false,
    "total_api_routes": 21,
    "total_pages": 17,
    "error_boundaries": 1,
    "loading_states": 0,
    "frontend_calls_api_inscriptions": false,
    "frontend_calls_api_bookings": true
  },

  "already_secured": {
    "price_verification_backend": {
      "file": "app/api/inscriptions/route.ts",
      "status": "DONE",
      "detail": "Requête gd_session_prices, rejet PRICE_MISMATCH si écart > 1€"
    },
    "payment_intent_from_db": {
      "file": "app/api/payment/create-intent/route.ts",
      "status": "DONE",
      "detail": "Lit inscription.price_total en DB, refuse amount frontend"
    },
    "webhook_idempotency": {
      "file": "app/api/webhooks/stripe/route.ts",
      "status": "DONE",
      "detail": "Check event.id dans gd_processed_events avant traitement"
    },
    "webhook_amount_check": {
      "file": "app/api/webhooks/stripe/route.ts",
      "status": "DONE",
      "detail": "Compare paymentIntent.amount/100 vs inscription.price_total, flag amount_mismatch"
    },
    "age_validation_global": {
      "file": "app/api/inscriptions/route.ts",
      "status": "DONE",
      "detail": "Validation 3-17 ans côté serveur (suffisant pour go-live)"
    },
    "orphan_monitoring": {
      "file": "sql/010_fk_constraints_not_valid.sql",
      "status": "DONE",
      "detail": "v_orphaned_records VIEW — 4 types d'orphelins détectés"
    }
  },

  "stabilization_steps": {
    "step_1": {
      "title": "Error boundaries + loading states",
      "priority": "P1",
      "severity": "MOYENNE",
      "effort": "30min",
      "risk": "ZERO — fichiers ajoutés, rien de modifié",
      "why": "Sans error.tsx par route, une erreur SSR = white screen en prod. Sans loading.tsx, les pages async affichent un blank pendant le fetch.",
      "current_state": {
        "error_tsx_exists": ["app/error.tsx (root only)"],
        "loading_tsx_exists": [],
        "pages_without_boundary": [
          "app/sejour/[id]/reserver/page.tsx",
          "app/sejour/[id]/page.tsx",
          "app/sejours/page.tsx",
          "app/recherche/page.tsx",
          "app/admin/* (5 pages)",
          "app/login/page.tsx"
        ]
      },
      "action": "Créer error.tsx et loading.tsx dans les répertoires critiques : sejour/[id], sejour/[id]/reserver, sejours, recherche, admin, login",
      "files_to_create": [
        "app/sejour/[id]/error.tsx",
        "app/sejour/[id]/loading.tsx",
        "app/sejour/[id]/reserver/error.tsx",
        "app/sejour/[id]/reserver/loading.tsx",
        "app/sejours/error.tsx",
        "app/sejours/loading.tsx",
        "app/recherche/error.tsx",
        "app/recherche/loading.tsx",
        "app/admin/error.tsx",
        "app/admin/loading.tsx",
        "app/login/error.tsx",
        "app/login/loading.tsx"
      ],
      "rollback": "git checkout -- app/sejour app/sejours app/recherche app/admin app/login (supprime les fichiers ajoutés)"
    },

    "step_2": {
      "title": "Filtre dates null dans reserver/page.tsx",
      "priority": "P1",
      "severity": "MOYENNE",
      "effort": "5min",
      "risk": "ZERO — filtre additionnel, ne casse pas les sessions valides",
      "why": "Si une session DB a start_date ou end_date null, le mapping camelCase passe null → formatDateLong crash 'Invalid Date'",
      "current_state": {
        "file": "app/sejour/[id]/reserver/page.tsx",
        "line": 30,
        "code": "const sessions = sessionsRaw.map((s: any, idx: number) => ({",
        "filter_present": false
      },
      "action": "Ajouter .filter(s => s.start_date && s.end_date) AVANT le .map()",
      "files_to_modify": ["app/sejour/[id]/reserver/page.tsx"],
      "rollback": "git checkout -- app/sejour/[id]/reserver/page.tsx"
    },

    "step_3": {
      "title": "Migrer booking-flow + booking-modal vers /api/inscriptions",
      "priority": "P0 — BLOQUANT SECURITE",
      "severity": "CRITIQUE",
      "effort": "1-2h",
      "risk": "MOYEN — modifie le parcours de réservation. Tester en Stripe test mode obligatoire.",
      "why": "booking-flow.tsx (L147) et booking-modal.tsx (L181) appellent POST /api/bookings (Prisma, DEPRECATED). Le circuit sécurisé /api/inscriptions avec vérification prix n'est appelé par AUCUN composant frontend. Toute la sécurité financière backend est BYPASSED.",
      "current_state": {
        "booking_flow": {
          "file": "components/booking-flow.tsx",
          "line": 147,
          "calls": "POST /api/bookings",
          "secure": false
        },
        "booking_modal": {
          "file": "components/booking-modal.tsx",
          "line": 181,
          "calls": "POST /api/bookings",
          "secure": false
        }
      },
      "action": "Adapter le payload envoyé par booking-flow et booking-modal pour matcher le schema attendu par /api/inscriptions (champs snake_case Supabase). Changer l'URL fetch. Adapter la gestion de réponse (inscriptionId au lieu de bookingId).",
      "files_to_modify": [
        "components/booking-flow.tsx",
        "components/booking-modal.tsx"
      ],
      "dependencies": ["L'API /api/inscriptions attend : sejour_slug, session_date, city_departure, jeune_prenom, jeune_nom, jeune_birthdate, parent_nom, parent_email, parent_phone, price_total"],
      "rollback": "git checkout -- components/booking-flow.tsx components/booking-modal.tsx"
    },

    "step_4": {
      "title": "Capacity read-only check (pas de décrement)",
      "priority": "P1",
      "severity": "MOYENNE",
      "effort": "20min",
      "risk": "FAIBLE — ajout d'un SELECT + guard dans /api/inscriptions, pas de modification de données",
      "why": "Actuellement /api/inscriptions accepte les inscriptions sans vérifier seats_left. Risque d'overbooking en prod.",
      "current_state": {
        "file": "app/api/inscriptions/route.ts",
        "capacity_check": false,
        "seats_left_column": "gd_stay_sessions.seats_left EXISTS mais non lu"
      },
      "action": "Après la vérification prix, ajouter un SELECT seats_left FROM gd_stay_sessions WHERE stay_slug AND start_date. Rejeter avec CAPACITY_FULL si seats_left <= 0.",
      "files_to_modify": ["app/api/inscriptions/route.ts"],
      "constraints": ["PAS de décrement", "PAS de transaction Supabase RPC", "Read-only check uniquement"],
      "rollback": "git checkout -- app/api/inscriptions/route.ts"
    },

    "step_5": {
      "title": "window.location.href → router.push (stay-detail)",
      "priority": "P2",
      "severity": "BASSE",
      "effort": "15min",
      "risk": "FAIBLE — changement de navigation interne",
      "why": "stay-detail.tsx L728 et L858 font window.location.href pour naviguer vers /reserver. Cela force un full page reload, perd l'état React, et crée un flash blanc.",
      "current_state": {
        "file": "app/sejour/[id]/stay-detail.tsx",
        "occurrences": [
          {"line": 728, "code": "window.location.href = `/sejour/${slug}/reserver?${params.toString()}`"},
          {"line": 858, "code": "window.location.href = `/sejour/${slug}/reserver?${params.toString()}`"}
        ],
        "other_occurrences_safe": [
          {"file": "app/admin/page.tsx", "lines": [29, 47], "note": "Admin redirect — acceptable"},
          {"file": "components/wishlist-modal.tsx", "line": 111, "note": "mailto: link — correct usage"},
          {"file": "app/sejour/[id]/stay-detail.tsx", "line": 164, "note": "mailto: link — correct usage"}
        ]
      },
      "action": "Importer useRouter de next/navigation. Remplacer les deux window.location.href par router.push().",
      "files_to_modify": ["app/sejour/[id]/stay-detail.tsx"],
      "rollback": "git checkout -- app/sejour/[id]/stay-detail.tsx"
    }
  },

  "not_in_scope": {
    "capacity_decrement": "V2 — nécessite RPC transaction Supabase",
    "session_uuid_migration": "V2 — documenté dans sql/010, nécessite backfill + refactor",
    "per_session_age_validation": "V2 — le global 3-17 suffit pour go-live",
    "cascade_delete": "INTERDIT par constraints",
    "trigger_creation": "INTERDIT par constraints",
    "not_null_enforcement": "V2",
    "prisma_cleanup": "P2 après migration frontend confirmée"
  },

  "go_live_checklist": {
    "pre_deploy": [
      "[ ] Steps 1-5 implémentés et testés localement",
      "[ ] npm run build passe sans erreur",
      "[ ] 0 TypeScript errors",
      "[ ] Parcours complet testé : séjour → reserver → inscription → paiement test",
      "[ ] Webhook Stripe testé avec stripe listen --forward-to"
    ],
    "env_vps": [
      "[ ] STRIPE_SECRET_KEY (sk_live_...)",
      "[ ] STRIPE_PUBLISHABLE_KEY (pk_live_...)",
      "[ ] STRIPE_WEBHOOK_SECRET (whsec_...)",
      "[ ] EMAIL_SERVICE_API_KEY (Resend)",
      "[ ] SUPABASE_SERVICE_ROLE_KEY",
      "[ ] NEXT_PUBLIC_SUPABASE_URL",
      "[ ] NEXT_PUBLIC_SUPABASE_ANON_KEY"
    ],
    "deploy": [
      "[ ] git pull origin work",
      "[ ] docker build",
      "[ ] docker compose up -d",
      "[ ] healthcheck OK",
      "[ ] DNS Resend vérifié pour groupeetdecouverte.fr"
    ],
    "post_deploy": [
      "[ ] Test inscription complète en mode test Stripe",
      "[ ] Vérifier v_orphaned_records = 0",
      "[ ] Switcher Stripe en live",
      "[ ] Désactiver /api/bookings (P2)"
    ]
  }
}
