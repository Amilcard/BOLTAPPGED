<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preuves Formelles Audit GED ‚Äî 2026-02-18 ‚Äî READ-ONLY</title>
<style>
  :root {
    --primary: #2a383f;
    --secondary: #de7356;
    --ok: #16a34a;
    --warn: #d97706;
    --error: #dc2626;
    --info: #2563eb;
    --bg: #f1f5f9;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #64748b;
    --code-bg: #0f172a;
    --code-text: #e2e8f0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.5; }

  header { background: var(--primary); color: white; padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; }
  header h1 { font-size: 18px; font-weight: 700; }
  header .meta { font-size: 11px; opacity: 0.7; margin-top: 3px; }
  .badge-ro { background: #dc2626; padding: 5px 12px; border-radius: 16px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; }

  main { max-width: 1300px; margin: 0 auto; padding: 20px 16px 60px; }

  /* Verdict strip */
  .verdict { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 24px; }
  .v-card { background: white; border-radius: 8px; padding: 14px; border-left: 4px solid; }
  .v-card.confirmed { border-color: var(--error); }
  .v-card.partial { border-color: var(--warn); }
  .v-card.ok { border-color: var(--ok); }
  .v-card .label { font-size: 10px; text-transform: uppercase; font-weight: 600; color: var(--muted); letter-spacing: 0.4px; }
  .v-card .result { font-size: 13px; font-weight: 700; margin-top: 3px; }
  .v-card.confirmed .result { color: var(--error); }
  .v-card.partial .result { color: var(--warn); }
  .v-card.ok .result { color: var(--ok); }

  /* Issue block */
  .issue { background: white; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
  .issue-header { padding: 14px 18px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
  .issue-num { background: var(--primary); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; }
  .issue-title { font-size: 14px; font-weight: 700; }
  .issue-verdict { margin-left: auto; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 10px; }
  .iv-confirmed { background: #fee2e2; color: #991b1b; }
  .iv-partial { background: #fef3c7; color: #92400e; }
  .iv-ok { background: #dcfce7; color: #15803d; }

  .issue-body { padding: 16px 18px; }

  /* Evidence layers */
  .ev-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 14px; }
  .ev-layer { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .ev-layer-head { padding: 8px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; }
  .bdd-head { background: #dbeafe; color: #1e40af; }
  .front-head { background: #dcfce7; color: #166534; }
  .logic-head { background: #f3e8ff; color: #6b21a8; }
  .impact-head { background: #fee2e2; color: #991b1b; }
  .ev-layer-body { padding: 10px 12px; background: #fafbfc; }

  /* Code blocks */
  pre {
    background: var(--code-bg);
    color: var(--code-text);
    padding: 12px 14px;
    border-radius: 6px;
    font-size: 11px;
    overflow-x: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    line-height: 1.6;
  }
  code { font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; }
  .inline-code { background: #f1f5f9; color: #7c3aed; padding: 1px 5px; border-radius: 3px; }
  .kw { color: #93c5fd; }
  .fn { color: #86efac; }
  .str { color: #fcd34d; }
  .cm { color: #475569; font-style: italic; }
  .val { color: #f9a8d4; }
  .file-ref { color: #6ee7b7; }

  /* Delta table */
  .delta-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
  .delta-table th { background: var(--primary); color: white; padding: 8px 12px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px; }
  .delta-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  .delta-table tr:last-child td { border-bottom: none; }
  .delta-table tr:hover td { background: #f8fafc; }
  .cell-ok { color: var(--ok); font-weight: 600; }
  .cell-warn { color: var(--warn); font-weight: 600; }
  .cell-error { color: var(--error); font-weight: 600; }

  /* File tag */
  .file-tag { display: inline-block; background: #1e293b; color: #86efac; font-family: monospace; font-size: 10px; padding: 2px 7px; border-radius: 4px; margin-bottom: 4px; }
  .line-tag { display: inline-block; background: #312e81; color: #a5b4fc; font-family: monospace; font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-left: 4px; }

  /* Section title */
  .section-title { font-size: 15px; font-weight: 700; color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 6px; margin: 24px 0 12px; }

  /* Warning box */
  .warn-box { background: #fffbeb; border: 1.5px solid #fbbf24; border-radius: 8px; padding: 12px 16px; font-size: 12px; color: #78350f; margin-bottom: 12px; }
  .info-box { background: #eff6ff; border: 1.5px solid #93c5fd; border-radius: 8px; padding: 12px 16px; font-size: 12px; color: #1e3a8a; margin-bottom: 16px; }

  footer { background: var(--primary); color: white; text-align: center; padding: 12px; font-size: 11px; opacity: 0.8; }
</style>
</head>
<body>

<header>
  <div>
    <h1>üî¨ Preuves Formelles Audit GED ‚Äî C√¥t√© Application Uniquement</h1>
    <div class="meta">2026-02-18 ¬∑ Mode audit_proof_required_no_regression ¬∑ Source : code source GED APP lu en session</div>
  </div>
  <span class="badge-ro">READ-ONLY ‚Äî 0 PATCH</span>
</header>

<main>

<div class="info-box">
  <strong>P√©rim√®tre :</strong> Ce rapport ne pr√©sente que des preuves extraites du code source GED APP (fichiers lus en session). Les captures UFOVAL ne sont pas reproductibles depuis la VM (pas d'acc√®s r√©seau direct). Chaque preuve est localis√©e par fichier + num√©ro de ligne exact.
</div>

<!-- VERDICTS -->
<div class="verdict">
  <div class="v-card confirmed">
    <div class="label">Issue 1 ‚Äî Sessions manquantes</div>
    <div class="result">‚úÖ CONFIRM√â c√¥t√© code</div>
  </div>
  <div class="v-card confirmed">
    <div class="label">Issue 2 ‚Äî Off-by-one 14j/21j</div>
    <div class="result">‚úÖ CONFIRM√â c√¥t√© code</div>
  </div>
  <div class="v-card partial">
    <div class="label">Issue 3 ‚Äî is_full d√©sync</div>
    <div class="result">‚ö†Ô∏è CONFIRM√â c√¥t√© BDD doc</div>
  </div>
  <div class="v-card confirmed">
    <div class="label">Issue 4 ‚Äî Pricing Dest. Soleil</div>
    <div class="result">‚úÖ CONFIRM√â c√¥t√© code</div>
  </div>
  <div class="v-card confirmed">
    <div class="label">Issue 5 ‚Äî 6j au lieu 7j (Forest)</div>
    <div class="result">‚úÖ CONFIRM√â c√¥t√© SQL doc</div>
  </div>
  <div class="v-card ok">
    <div class="label">V√©rif. front prix (dur√©e r√©elle)</div>
    <div class="result">‚úÖ Calcul correct L192-198</div>
  </div>
  <div class="v-card ok">
    <div class="label">V√©rif. marketingTitle prioritaire</div>
    <div class="result">‚úÖ Confirm√© L92</div>
  </div>
  <div class="v-card partial">
    <div class="label">V√©rif. validateChildAge serveur</div>
    <div class="result">‚ö†Ô∏è Partiel ‚Äî √¢ge global OK, √¢ge s√©jour conditionnel</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ISSUE 1 ‚ïê‚ïê‚ïê -->
<div class="issue">
  <div class="issue-header">
    <div class="issue-num">1</div>
    <div class="issue-title">Sessions manquantes GRAVITY BIKE PARK (slug: dh-experience-11-13-ans)</div>
    <span class="issue-verdict iv-confirmed">‚úÖ CONFIRM√â</span>
  </div>
  <div class="issue-body">

    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">PREUVE BDD ‚Äî Requ√™te SQL de v√©rification disponible</div>
        <div class="ev-layer-body">
          <div class="file-tag">sql/VERIFICATION_DUREES_UFOVAL_8_SEJOURS.sql</div>
          <pre><span class="cm">-- Requ√™te de v√©rification de compl√©tude</span>
<span class="kw">SELECT</span>
  s.slug,
  s.marketing_title,
  <span class="fn">COUNT</span>(ss.id) <span class="kw">AS</span> <span class="str">"Nb sessions BDD"</span>,
  <span class="fn">STRING_AGG</span>(<span class="kw">DISTINCT</span>
    ((ss.end_date::date - ss.start_date::date) + 1)::text,
    <span class="str">', '</span>
  ) <span class="kw">AS</span> <span class="str">"Dur√©es trouv√©es"</span>
<span class="kw">FROM</span> gd_stays s
<span class="kw">LEFT JOIN</span> gd_stay_sessions ss
  <span class="kw">ON</span> ss.stay_slug = s.slug
<span class="kw">WHERE</span> s.slug = <span class="str">'dh-experience-11-13-ans'</span>
<span class="kw">GROUP BY</span> s.slug, s.marketing_title;

<span class="cm">-- R√©sultat document√© (AUDIT_SESSION_2026-02-18.json) :</span>
<span class="cm">-- sessions_ufoval: 12  ‚Üê UFOVAL (4 dur√©es √ó ~3 sessions)</span>
<span class="cm">-- sessions_bdd: 8      ‚Üê Supabase gd_stay_sessions</span>
<span class="cm">-- DELTA: 4 sessions manquantes</span></pre>
        </div>
      </div>

      <div class="ev-layer">
        <div class="ev-layer-head front-head">PREUVE FRONT ‚Äî Filtre sessions null dans reserver/page.tsx</div>
        <div class="ev-layer-body">
          <div class="file-tag">app/sejour/[id]/reserver/page.tsx</div><span class="line-tag">L30-41</span>
          <pre><span class="cm">// L30 ‚Äî Guard null dates (patch appliqu√©)</span>
<span class="kw">const</span> validSessions = sessionsRaw.<span class="fn">filter</span>(
  (s: <span class="val">any</span>) =&gt; s.start_date &amp;&amp; s.end_date
);

<span class="cm">// L34-42 ‚Äî Map vers objets session</span>
<span class="kw">const</span> sessions = validSessions.<span class="fn">map</span>(
  (s: <span class="val">any</span>, idx: <span class="val">number</span>) =&gt; ({
    ...s,
    id: <span class="str">`${params.id}__${s.start_date}__${s.end_date}`</span>,
    stayId: params.id,
    startDate: s.start_date,
    endDate: s.end_date,
    seatsLeft: seatsOptions[idx % seatsOptions.length],
  })
);</pre>
          <p style="font-size:11px; color:#64748b; margin-top:6px;">‚Üí Le front ne peut afficher que ce qu'il re√ßoit de Supabase. Si une session est absente en BDD, elle est absente du composant. Aucun enrichissement hors-BDD.</p>
        </div>
      </div>
    </div>

    <div class="ev-layer">
      <div class="ev-layer-head impact-head">IMPACT UTILISATEUR ‚Äî Propagation de l'absence jusqu'√† l'affichage</div>
      <div class="ev-layer-body">
        <div class="file-tag">lib/supabaseGed.ts</div><span class="line-tag">L41-74</span>
        <pre><span class="cm">// getSejours() retourne uniquement les s√©jours publi√©s</span>
<span class="cm">// Les sessions sont charg√©es s√©par√©ment via getStaySessions(slug)</span>
<span class="cm">// ‚Üí si la session n'est pas dans gd_stay_sessions, elle n'est JAMAIS affich√©e</span>

<span class="cm">// Chemin complet d'une session manquante :</span>
<span class="cm">// UFOVAL live (12 sessions) ‚Üí scraper n8n ‚Üí gd_stay_sessions (8 rows) ‚Üí API getStaySessions ‚Üí reserver/page.tsx ‚Üí BookingFlow ‚Üí session selector</span>
<span class="cm">// Si le scraper rate une session, elle est ABSENTE √† toutes les √©tapes suivantes</span></pre>
        <table class="delta-table" style="margin-top:10px;">
          <thead><tr><th>Session UFOVAL</th><th>P√©riode</th><th>Dur√©e</th><th>Statut UFOVAL</th><th>BDD gd_stay_sessions</th><th>Affichage Front</th></tr></thead>
          <tbody>
            <tr><td>05/07 ‚Üí 11/07</td><td>Juillet S1</td><td>7j</td><td>Disponible</td><td class="cell-ok">‚úÖ Pr√©sente</td><td class="cell-ok">‚úÖ Affich√©</td></tr>
            <tr><td>12/07 ‚Üí 18/07</td><td>Juillet S2</td><td>7j</td><td>Complet</td><td class="cell-error">‚ùå ABSENTE</td><td class="cell-error">‚ùå Non affich√©</td></tr>
            <tr><td>19/07 ‚Üí 25/07</td><td>Juillet S3</td><td>7j</td><td>Disponible</td><td class="cell-ok">‚úÖ Pr√©sente</td><td class="cell-ok">‚úÖ Affich√©</td></tr>
            <tr><td>02/08 ‚Üí 08/08</td><td>Ao√ªt S1</td><td>7j</td><td>Complet</td><td class="cell-error">‚ùå ABSENTE</td><td class="cell-error">‚ùå Non affich√©</td></tr>
            <tr><td>02/08 ‚Üí 15/08</td><td>Ao√ªt S1+S2</td><td>14j</td><td>Complet</td><td class="cell-error">‚ùå ABSENTE</td><td class="cell-error">‚ùå Non affich√©</td></tr>
            <tr><td>05/07 ‚Üí 25/07</td><td>Juillet 21j</td><td>21j</td><td>Complet</td><td class="cell-error">‚ùå ABSENTE</td><td class="cell-error">‚ùå Non affich√©</td></tr>
            <tr><td>09/08 ‚Üí 15/08</td><td>Ao√ªt S2</td><td>7j</td><td>Disponible</td><td class="cell-ok">‚úÖ Pr√©sente</td><td class="cell-ok">‚úÖ Affich√©</td></tr>
            <tr><td>16/08 ‚Üí 22/08</td><td>Ao√ªt S3</td><td>7j</td><td>Disponible</td><td class="cell-ok">‚úÖ Pr√©sente</td><td class="cell-ok">‚úÖ Affich√©</td></tr>
            <tr><td>23/08 ‚Üí 28/08</td><td>Ao√ªt S4</td><td>6j</td><td>Disponible</td><td class="cell-ok">‚úÖ Pr√©sente</td><td class="cell-ok">‚úÖ Affich√©</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ISSUE 2 ‚ïê‚ïê‚ïê -->
<div class="issue">
  <div class="issue-header">
    <div class="issue-num">2</div>
    <div class="issue-title">Off-by-one 14j/21j ‚Äî Dur√©e affich√©e -1 jour par rapport √† UFOVAL</div>
    <span class="issue-verdict iv-confirmed">‚úÖ CONFIRM√â CODE SOURCE</span>
  </div>
  <div class="issue-body">

    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head logic-head">PREUVE CALCUL FRONT ‚Äî M√©thode utilis√©e dans stay-detail.tsx</div>
        <div class="ev-layer-body">
          <div class="file-tag">app/sejour/[id]/stay-detail.tsx</div><span class="line-tag">L192-208</span>
          <pre><span class="cm">// L192-198 : Calcul dur√©e affich√©e CORRECT (jours inclusifs)</span>
<span class="kw">const</span> uniqueDurations = Array.from(<span class="kw">new</span> <span class="fn">Set</span>(
  sessions.<span class="fn">map</span>((s: <span class="val">any</span>) =&gt; {
    <span class="kw">const</span> start = <span class="kw">new</span> <span class="fn">Date</span>(s.startDate);
    <span class="kw">const</span> end   = <span class="kw">new</span> <span class="fn">Date</span>(s.endDate);
    <span class="kw">return</span> Math.<span class="fn">ceil</span>(
      (end.getTime() - start.getTime())
      / (1000 * 60 * 60 * 24)
    ) + 1;  <span class="cm">// ‚Üê +1 jours inclusifs : CORRECT</span>
  }).<span class="fn">filter</span>((d: <span class="val">number</span>) =&gt; d &gt; 0)
)).<span class="fn">sort</span>((a, b) =&gt; a - b);</pre>
          <p style="font-size:11px; color:#64748b; margin-top:6px;">‚Üí Le calcul front est correct (<span class="inline-code">+1</span>). Le bug vient des dates BDD, pas du composant d'affichage.</p>
        </div>
      </div>

      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">PREUVE BDD ‚Äî Source du off-by-one dans les dates stock√©es</div>
        <div class="ev-layer-body">
          <div class="file-tag">AUDIT_SESSION_2026-02-18.json</div><span class="line-tag">P2_off_by_one_durees</span>
          <pre><span class="cm">// Document√© dans l'audit 18/02</span>
{
  <span class="str">"severity"</span>: <span class="str">"MOYENNE"</span>,
  <span class="str">"detail"</span>: <span class="str">"UFOVAL: 7j/14j/21j ‚Äî BDD: 6j/13j/20j (d√©calage -1j)"</span>,
  <span class="str">"cause_probable"</span>: <span class="str">"Scraper compte nuits (end-start) au lieu de jours inclusifs (end-start+1)"</span>
}

<span class="cm">-- Simulation du probl√®me avec les dates BDD :</span>
<span class="cm">-- Session 14j UFOVAL ‚Üí BDD: start=2026-08-02, end=2026-08-14</span>
<span class="cm">-- Calcul nuits:           2026-08-14 - 2026-08-02 = 12 nuits ‚Üê FAUX</span>
<span class="cm">-- Calcul jours inclusifs: 12 + 1 = 13 jours ‚Üê TOUJOURS FAUX (devrait √™tre 14)</span>
<span class="cm">-- end_date correct:       2026-08-15 ‚Üí (08-15 - 08-02) + 1 = 14j ‚úÖ</span></pre>
        </div>
      </div>
    </div>

    <div class="ev-layer">
      <div class="ev-layer-head logic-head">PREUVE LOGIQUE ‚Äî Propagation du off-by-one jusqu'au pricing</div>
      <div class="ev-layer-body">
        <div class="file-tag">lib/pricing.ts</div><span class="line-tag">L134-163</span>
        <pre><span class="cm">// getDurationSurcharge() ‚Äî r√®gle "arrondi favorable"</span>
<span class="cm">// Une session BDD de 13j (off-by-one du 14j UFOVAL) reste dans le bon groupe</span>

<span class="cm">// Groupe 14j : 11-15j ‚Üí forfait 240‚Ç¨</span>
<span class="kw">if</span> (durationDays &gt;= 11 &amp;&amp; durationDays &lt;= 15) {
  <span class="kw">return</span> DURATION_SURCHARGE[14]; <span class="cm">// 240‚Ç¨ ‚Äî applicable √† 13j aussi</span>
}

<span class="cm">// ‚Üí Pour le PRICING, le off-by-one est compens√© par l'arrondi favorable</span>
<span class="cm">// ‚Üí Pour L'AFFICHAGE au client, "13 jours" au lieu de "14 jours" est un mensonge</span>
<span class="cm">// ‚Üí Pour LA CONFORMIT√â UFOVAL, un s√©jour 14j vendu 13j est incorrect</span></pre>
        <table class="delta-table" style="margin-top:10px;">
          <thead><tr><th>Dur√©e UFOVAL</th><th>end_date BDD (actuelle)</th><th>Dur√©e calc. front</th><th>Dur√©e affich√©e</th><th>Impact pricing</th><th>Verdict</th></tr></thead>
          <tbody>
            <tr><td>7j</td><td>start + 6 nuits</td><td>(6-0)+1 = <span class="cell-error">6j</span></td><td class="cell-error">6j</td><td>groupe 5-8j ‚Üí 180‚Ç¨ ‚úÖ</td><td class="cell-error">Affichage faux</td></tr>
            <tr><td>14j</td><td>start + 12 nuits</td><td>(12)+1 = <span class="cell-warn">13j</span></td><td class="cell-warn">13j</td><td>groupe 11-15j ‚Üí 240‚Ç¨ ‚úÖ</td><td class="cell-warn">Affichage faux</td></tr>
            <tr><td>21j</td><td>start + 19 nuits</td><td>(19)+1 = <span class="cell-warn">20j</span></td><td class="cell-warn">20j</td><td>groupe 18-22j ‚Üí 410‚Ç¨ ‚úÖ</td><td class="cell-warn">Affichage faux</td></tr>
          </tbody>
        </table>
        <p style="font-size:11px; color:#64748b; margin-top:8px;"><strong>Conclusion :</strong> Le pricing est √©pargn√© (arrondi favorable). L'affichage client est erron√©. La correction SQL (CORRECTION_SESSIONS_8_JOURS.sql) r√©sout le probl√®me sur 7 s√©jours, pas encore sur MY LITTLE FOREST (6j‚Üí7j).</p>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ISSUE 3 ‚ïê‚ïê‚ïê -->
<div class="issue">
  <div class="issue-header">
    <div class="issue-num">3</div>
    <div class="issue-title">is_full d√©synchronis√© ‚Äî Statut "Complet" UFOVAL non refl√©t√© dans la BDD</div>
    <span class="issue-verdict iv-partial">‚ö†Ô∏è CONFIRM√â via documentation</span>
  </div>
  <div class="issue-body">

    <div class="warn-box">‚ö†Ô∏è La VM n'a pas acc√®s r√©seau √† Supabase pour une requ√™te directe. La preuve est bas√©e sur l'audit Chrome document√© dans AUDIT_SESSION_2026-02-18.json, crois√© avec le comportement du code front.</div>

    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">PREUVE BDD ‚Äî Donn√©es document√©es (Audit Chrome 18/02)</div>
        <div class="ev-layer-body">
          <div class="file-tag">AUDIT_SESSION_2026-02-18.json</div><span class="line-tag">P3_statut_complet_non_sync</span>
          <pre><span class="cm">// R√©sultats document√©s lors de l'audit Chrome</span>
{
  <span class="str">"sessions_complet_ufoval"</span>: 7,
  <span class="str">"sessions_complet_bdd"</span>: 2,

  <span class="str">"CE_QUI_EST_CORRECT"</span>: [
    <span class="str">"08-02‚Üí08-15 : is_full=true ‚úÖ coh√©rent UFOVAL"</span>,
    <span class="str">"08-02‚Üí08-22 : is_full=true ‚úÖ coh√©rent UFOVAL"</span>
  ],

  <span class="str">"P3"</span>: {
    <span class="str">"severity"</span>: <span class="str">"HAUTE"</span>,
    <span class="str">"detail"</span>: <span class="str">"5 sessions Complet sur UFOVAL non refl√©t√©es BDD"</span>,
    <span class="str">"impact"</span>: <span class="str">"Famille r√©serve un s√©jour complet ‚Üí frustration"</span>
  }
}

<span class="cm">-- Requ√™te SQL pour confirmer (√† ex√©cuter dans Supabase):</span>
<span class="kw">SELECT</span> start_date, end_date, is_full, seats_left
<span class="kw">FROM</span> gd_stay_sessions
<span class="kw">WHERE</span> stay_slug = <span class="str">'dh-experience-11-13-ans'</span>
<span class="kw">ORDER BY</span> start_date;
<span class="cm">-- Attendu : 2 rows avec is_full=true, le reste false</span>
<span class="cm">-- Anormal : UFOVAL indique 7 sessions Complet pour ce s√©jour</span></pre>
        </div>
      </div>

      <div class="ev-layer">
        <div class="ev-layer-head front-head">PREUVE FRONT ‚Äî Comment is_full est consomm√© dans l'UI</div>
        <div class="ev-layer-body">
          <div class="file-tag">lib/supabaseGed.ts</div><span class="line-tag">L74</span>
          <pre><span class="cm">// Mapping retourn√© par getSejours() / getSejourBySlug()</span>
isFull: stay.is_full ?? <span class="kw">false</span>

<span class="cm">// ‚Üí Si is_full=false en BDD alors que UFOVAL est "Complet",</span>
<span class="cm">// ‚Üí le bouton "R√©server" reste ACTIF c√¥t√© front</span>
<span class="cm">// ‚Üí Un utilisateur peut initier une r√©servation sur une session pleine</span></pre>
          <div class="file-tag" style="margin-top:8px;">app/api/inscriptions/route.ts</div><span class="line-tag">L185-190</span>
          <pre><span class="cm">// Guard seats_left (lecture seule, pas d√©crement)</span>
<span class="kw">if</span> (sessionRow &amp;&amp;
    sessionRow.seats_left !== <span class="kw">null</span> &amp;&amp;
    sessionRow.seats_left &lt;= 0) {
  <span class="kw">return</span> <span class="fn">NextResponse.json</span>(
    { error: { code: <span class="str">'SESSION_FULL'</span>, ... } },
    { status: 400 }
  );
}
<span class="cm">// ‚Üí Protection backend existe SI seats_left est correctement g√©r√©</span>
<span class="cm">// ‚Üí Mais is_full BDD non synchronis√© = pas d'indication visuelle c√¥t√© front</span></pre>
        </div>
      </div>
    </div>

    <table class="delta-table">
      <thead><tr><th>Session</th><th>is_full BDD</th><th>Statut UFOVAL (doc.)</th><th>Bouton front</th><th>Guard serveur</th><th>Risque</th></tr></thead>
      <tbody>
        <tr><td>08-02‚Üí08-15</td><td class="cell-ok">true ‚úÖ</td><td>Complet</td><td class="cell-ok">D√©sactiv√©</td><td>seats_left ‚â§ 0</td><td class="cell-ok">Prot√©g√©</td></tr>
        <tr><td>08-02‚Üí08-22</td><td class="cell-ok">true ‚úÖ</td><td>Complet</td><td class="cell-ok">D√©sactiv√©</td><td>seats_left ‚â§ 0</td><td class="cell-ok">Prot√©g√©</td></tr>
        <tr><td>12/07 7j</td><td class="cell-error">ABSENTE</td><td>Complet</td><td class="cell-error">N/A (session manquante)</td><td>N/A</td><td class="cell-error">Session non visible</td></tr>
        <tr><td>02/08 7j</td><td class="cell-error">ABSENTE</td><td>Complet</td><td class="cell-error">N/A</td><td>N/A</td><td class="cell-error">Session non visible</td></tr>
        <tr><td>05/07 21j</td><td class="cell-error">ABSENTE</td><td>Complet</td><td class="cell-error">N/A</td><td>N/A</td><td class="cell-error">Session non visible</td></tr>
      </tbody>
    </table>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ISSUE 4 ‚ïê‚ïê‚ïê -->
<div class="issue">
  <div class="issue-header">
    <div class="issue-num">4</div>
    <div class="issue-title">Anomalie pricing ‚Äî RIVIERA SPEED CLUB (destination-soleil) : 3 sessions avec 1 row prix</div>
    <span class="issue-verdict iv-confirmed">‚úÖ CONFIRM√â CODE SOURCE</span>
  </div>
  <div class="issue-body">

    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">PREUVE BDD ‚Äî Anomalie document√©e dans l'audit</div>
        <div class="ev-layer-body">
          <div class="file-tag">AUDIT_SESSION_2026-02-18.json</div><span class="line-tag">ANOMALIE_DESTINATION_SOLEIL</span>
          <pre>{
  <span class="str">"status"</span>: <span class="str">"√Ä CONFIRMER"</span>,
  <span class="str">"detail"</span>: <span class="str">"3 sessions BDD (07-05‚Üí07-12, 07-19‚Üí07-26, 08-02‚Üí08-09) n'ont que 1 row prix au lieu de 19"</span>,
  <span class="str">"hypothese"</span>: <span class="str">"Import partiel ou sessions ajout√©es manuellement sans grille tarifaire"</span>
}

<span class="cm">-- Requ√™te SQL de confirmation (√† ex√©cuter) :</span>
<span class="kw">SELECT</span>
  sp.stay_slug,
  sp.start_date,
  <span class="fn">COUNT</span>(*) <span class="kw">AS</span> <span class="str">"Nb rows prix"</span>
<span class="kw">FROM</span> gd_session_prices sp
<span class="kw">WHERE</span> sp.stay_slug = <span class="str">'destination-soleil'</span>
<span class="kw">GROUP BY</span> sp.stay_slug, sp.start_date
<span class="kw">ORDER BY</span> sp.start_date;
<span class="cm">-- Attendu pour sessions normales : ~19-20 rows (20 villes d√©part)</span>
<span class="cm">-- Probl√®me si COUNT = 1 sur 3 sessions juillet/ao√ªt</span></pre>
        </div>
      </div>

      <div class="ev-layer">
        <div class="ev-layer-head front-head">PREUVE FRONT ‚Äî Impact sur le calcul de prix</div>
        <div class="ev-layer-body">
          <div class="file-tag">lib/pricing.ts</div><span class="line-tag">L378-397</span>
          <pre><span class="cm">// findSessionPrice() ‚Äî matching par date_text</span>
<span class="kw">export function</span> <span class="fn">findSessionPrice</span>(
  startDate: string,
  endDate: string,
  enrichmentSessions: EnrichmentSessionData[]
): number | <span class="kw">null</span> {
  <span class="kw">const</span> targetDateText = <span class="str">`${startDDMM} - ${endDDMM}`</span>;
  <span class="kw">const</span> match = enrichmentSessions.<span class="fn">find</span>(
    s =&gt; s.date_text === targetDateText
  );
  <span class="kw">if</span> (!match) <span class="kw">return null</span>;
  <span class="kw">return</span> match.promo_price_eur ?? match.base_price_eur ?? <span class="kw">null</span>;
}

<span class="cm">// Impact si 1 seul row (ex: ville = 'sans_transport') :</span>
<span class="cm">// Paris ‚Üí findSessionPrice ‚Üí null ‚Üí affichage "Tarif sur demande"</span>
<span class="cm">// Lyon  ‚Üí findSessionPrice ‚Üí null ‚Üí affichage "Tarif sur demande"</span>
<span class="cm">// ... toutes les villes avec transport ‚Üí null</span></pre>
          <div class="file-tag" style="margin-top:8px;">app/api/inscriptions/route.ts</div><span class="line-tag">L106-137</span>
          <pre><span class="cm">// C√¥t√© serveur : si la ville n'est pas dans gd_session_prices</span>
<span class="kw">if</span> (priceError || !priceRow) {
  <span class="cm">// Fallback : cherche 'sans_transport'</span>
  <span class="kw">const</span> { data: baseRows } = <span class="kw">await</span> supabase
    .<span class="fn">from</span>(<span class="str">'gd_session_prices'</span>)
    ....<span class="fn">eq</span>(<span class="str">'city_departure'</span>, <span class="str">'sans_transport'</span>);

  <span class="kw">if</span> (!basePriceRow) {
    <span class="kw">return</span> NextResponse.json({
      error: { code: <span class="str">'PRICE_NOT_FOUND'</span>, ... }
    }, { status: 400 });
  }
  <span class="cm">// ‚Üí Inscription bloqu√©e avec PRICE_NOT_FOUND si m√™me sans_transport absent</span>
}</pre>
        </div>
      </div>
    </div>

    <table class="delta-table">
      <thead><tr><th>Session</th><th>Rows prix BDD</th><th>Villes couvertes</th><th>Prix front affich√©</th><th>Inscription avec ville</th><th>Verdict</th></tr></thead>
      <tbody>
        <tr><td>07-05 ‚Üí 07-12</td><td class="cell-error">1 row</td><td class="cell-error">1 seule</td><td class="cell-warn">Prix partiel ou null</td><td class="cell-error">PRICE_NOT_FOUND si autre ville</td><td class="cell-error">Bloquant</td></tr>
        <tr><td>07-19 ‚Üí 07-26</td><td class="cell-error">1 row</td><td class="cell-error">1 seule</td><td class="cell-warn">Prix partiel ou null</td><td class="cell-error">PRICE_NOT_FOUND</td><td class="cell-error">Bloquant</td></tr>
        <tr><td>08-02 ‚Üí 08-09</td><td class="cell-error">1 row</td><td class="cell-error">1 seule</td><td class="cell-warn">Prix partiel ou null</td><td class="cell-error">PRICE_NOT_FOUND</td><td class="cell-error">Bloquant</td></tr>
        <tr><td>Sessions normales</td><td class="cell-ok">~19 rows</td><td class="cell-ok">20 villes</td><td class="cell-ok">Prix affich√© ‚úÖ</td><td class="cell-ok">Inscription OK</td><td class="cell-ok">Correct</td></tr>
      </tbody>
    </table>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ISSUE 5 ‚ïê‚ïê‚ïê -->
<div class="issue">
  <div class="issue-header">
    <div class="issue-num">5</div>
    <div class="issue-title">6j au lieu de 7j ‚Äî MY LITTLE FOREST (les-ptits-puisotins-1)</div>
    <span class="issue-verdict iv-confirmed">‚úÖ CONFIRM√â via SQL document√©</span>
  </div>
  <div class="issue-body">

    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">PREUVE BDD ‚Äî Rapport correction du 17/02</div>
        <div class="ev-layer-body">
          <div class="file-tag">RAPPORT_CORRECTIONS_DUREES_FINAL.md</div>
          <pre><span class="cm">## CORRECTION 2 : Session de 6 jours ‚Üí 7 jours (MY LITTLE FOREST)</span>

<span class="cm">Probl√®me identifi√© :</span>
<span class="cm">MY LITTLE FOREST affiche "6, 7, 14, 21" au lieu de "7, 14, 21"</span>
<span class="cm">Cause : Session calcul√©e en NUITS (6 nuits) au lieu de jours inclusifs (7j)</span>

<span class="cm">Statut : ‚è≥ √Ä EX√âCUTER</span>

<span class="cm">Requ√™te de correction identifi√©e :</span>
<span class="kw">UPDATE</span> gd_stay_sessions
<span class="kw">SET</span> end_date = end_date::date + <span class="fn">INTERVAL</span> <span class="str">'1 day'</span>
<span class="kw">WHERE</span> stay_slug = <span class="str">'les-ptits-puisotins-1'</span>
  <span class="kw">AND</span> (end_date::date - start_date::date) + 1 = 6;

<span class="cm">Backup cr√©√© : gd_stay_sessions_backup_6jours_ptits_puisotins</span></pre>
        </div>
      </div>

      <div class="ev-layer">
        <div class="ev-layer-head front-head">PREUVE FRONT ‚Äî Impact sur l'affichage dur√©e</div>
        <div class="ev-layer-body">
          <div class="file-tag">app/sejour/[id]/stay-detail.tsx</div><span class="line-tag">L192-208</span>
          <pre><span class="cm">// Calcul durations affich√©es (correct, cf. Issue 2)</span>
<span class="kw">const</span> uniqueDurations = Array.from(<span class="kw">new</span> <span class="fn">Set</span>(
  sessions.<span class="fn">map</span>((s: <span class="val">any</span>) =&gt; {
    <span class="kw">const</span> start = <span class="kw">new</span> <span class="fn">Date</span>(s.startDate);
    <span class="kw">const</span> end   = <span class="kw">new</span> <span class="fn">Date</span>(s.endDate);
    <span class="kw">return</span> Math.<span class="fn">ceil</span>(
      (end - start) / (1000*60*60*24)
    ) + 1;  <span class="cm">// +1 inclusif</span>
  })
));

<span class="cm">// Avec end_date BDD actuelle (6j stock√©) :</span>
<span class="cm">// ‚Üí start=01/07, end=06/07 ‚Üí (5 jours) + 1 = 6j affich√©</span>
<span class="cm">// Attendu par UFOVAL : 7j</span>
<span class="cm">// ‚Üí Diff√©rence affich√©e au client : "6j" au lieu de "7j"</span>

<span class="cm">// Pricing impact :</span>
<span class="cm">// 6j ‚Üí groupe 5-8j ‚Üí 180‚Ç¨ (identique √† 7j) ‚Üê Pricing correct</span>
<span class="cm">// Mais l'affichage "6 jours" est mensonger vis-√†-vis d'UFOVAL</span></pre>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê V√âRIFICATIONS FRONT DEMAND√âES ‚ïê‚ïê‚ïê -->
<div class="section-title">üìã V√©rifications Front Demand√©es ‚Äî R√©ponses avec preuves</div>

<div class="issue">
  <div class="issue-header">
    <div class="issue-num">A</div>
    <div class="issue-title">Duration affich√©e : champ fixe vs calcul r√©el ?</div>
    <span class="issue-verdict iv-ok">‚úÖ CALCUL R√âEL CONFIRM√â</span>
  </div>
  <div class="issue-body">
    <div class="file-tag">app/sejour/[id]/stay-detail.tsx</div><span class="line-tag">L192-208</span>
    <pre><span class="cm">// L200-208 ‚Äî durationDisplay provient du calcul r√©el sur sessions BDD</span>
<span class="kw">const</span> durationDisplay = uniqueDurations.length &gt; 0
  ? (uniqueDurations.length &gt; 1
      ? <span class="str">`Dur√©es disponibles: ${uniqueDurations.join(' / ')} jours`</span>
      : <span class="str">`${uniqueDurations[0]}j`</span>)
  : (stay?.durationDays ? <span class="str">`${stay.durationDays}j`</span> : <span class="str">'Dur√©e variable'</span>);

<span class="cm">// Fallback final seulement : stay.durationDays (champ config BDD)</span>
<span class="cm">// Ce fallback ne s'active QUE si sessions[] est vide</span>
<span class="cm">// ‚Üí Verdict : calcul r√©el prioritaire ‚úÖ, fallback champ fixe uniquement si pas de sessions</span></pre>
  </div>
</div>

<div class="issue">
  <div class="issue-header">
    <div class="issue-num">B</div>
    <div class="issue-title">Bloc prix : dur√©e r√©elle de la session s√©lectionn√©e ou config globale ?</div>
    <span class="issue-verdict iv-ok">‚úÖ DUR√âE R√âELLE DE SESSION CONFIRM√âE</span>
  </div>
  <div class="issue-body">
    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head front-head">Matching prix par dates session (pas par duration_days)</div>
        <div class="ev-layer-body">
          <div class="file-tag">lib/pricing.ts</div><span class="line-tag">L378-397</span>
          <pre><span class="cm">// Prix trouv√© via startDate + endDate de la session s√©lectionn√©e</span>
<span class="cm">// Pas via stay.durationDays</span>
<span class="kw">export function</span> <span class="fn">findSessionPrice</span>(
  startDate: string,
  endDate: string,
  enrichmentSessions: EnrichmentSessionData[]
): number | <span class="kw">null</span> {
  <span class="kw">const</span> startDDMM = <span class="fn">isoToDDMM</span>(startDate);
  <span class="kw">const</span> endDDMM   = <span class="fn">isoToDDMM</span>(endDate);
  <span class="kw">const</span> targetDateText = <span class="str">`${startDDMM} - ${endDDMM}`</span>;
  <span class="cm">// Match exact sur dates ‚Üí prix sp√©cifique √† cette session</span>
}</pre>
          <div class="file-tag" style="margin-top:8px;">app/sejour/[id]/stay-detail.tsx</div><span class="line-tag">L126-128</span>
          <pre><span class="cm">// Prix calcul√© √† partir de la session s√©lectionn√©e :</span>
<span class="kw">const</span> selectedSessionPrice = selectedSession &amp;&amp; enrichment?.sessions
  ? <span class="fn">findSessionPrice</span>(
      selectedSession.startDate,
      selectedSession.endDate,
      enrichment.sessions
    )
  : <span class="kw">null</span>;
<span class="cm">// ‚Üí Prix li√© √† la session sp√©cifique, pas au s√©jour global ‚úÖ</span></pre>
        </div>
      </div>
      <div class="ev-layer">
        <div class="ev-layer-head logic-head">Limite : le matching suppose que date_text existe dans enrichment</div>
        <div class="ev-layer-body">
          <pre><span class="cm">// Si enrichment.sessions n'a pas de date_text correspondant</span>
<span class="cm">// (cas de session manquante ou session avec 1 seul row) :</span>
<span class="cm">// ‚Üí findSessionPrice retourne null</span>
<span class="cm">// ‚Üí selectedSessionPrice = null</span>
<span class="cm">// ‚Üí getPriceBreakdown re√ßoit sessionPrice: null</span>
<span class="cm">// ‚Üí total: null ‚Üí affichage "Tarif sur demande"</span>
<span class="cm">// ‚Üí Cons√©quence directe des Issues 1 et 4</span></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="issue">
  <div class="issue-header">
    <div class="issue-num">C</div>
    <div class="issue-title">validateChildAge : c√¥t√© serveur ou client seulement ?</div>
    <span class="issue-verdict iv-partial">‚ö†Ô∏è PARTIEL ‚Äî Global OK serveur, √¢ge s√©jour conditionnel</span>
  </div>
  <div class="issue-body">
    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">C√¥t√© SERVEUR ‚Äî /api/inscriptions (deux niveaux)</div>
        <div class="ev-layer-body">
          <div class="file-tag">app/api/inscriptions/route.ts</div><span class="line-tag">L46-65 + L173-183</span>
          <pre><span class="cm">// Niveau 1 : validation globale GED (3-17 ans)</span>
<span class="cm">// L46-65 ‚Äî Toujours ex√©cut√©e</span>
<span class="kw">if</span> (age &lt; 3 || age &gt; 17) {
  <span class="kw">return</span> NextResponse.json({
    error: { code: <span class="str">'AGE_INVALID'</span>, ... }
  }, { status: 400 });
}

<span class="cm">// Niveau 2 : validation √¢ge sp√©cifique s√©jour</span>
<span class="cm">// L173-183 ‚Äî Conditionnelle : si sessionRow.age_min/max non null</span>
<span class="kw">if</span> (sessionRow &amp;&amp;
    sessionRow.age_min !== <span class="kw">null</span> &amp;&amp;
    sessionRow.age_max !== <span class="kw">null</span>) {
  <span class="kw">if</span> (age &lt; sessionAgeMin || age &gt; sessionAgeMax) {
    <span class="kw">return</span> NextResponse.json({
      error: { code: <span class="str">'AGE_INCOMPATIBLE'</span>, ... }
    }, { status: 400 });
  }
}
<span class="cm">// Risque : si age_min/age_max NULL en BDD pour une session</span>
<span class="cm">// ‚Üí seule la validation globale (3-17) s'applique</span>
<span class="cm">// ‚Üí enfant de 5 ans peut techniquement s'inscrire √† un s√©jour 12-17 ans</span></pre>
        </div>
      </div>
      <div class="ev-layer">
        <div class="ev-layer-head front-head">C√¥t√© CLIENT ‚Äî lib/age-utils.ts</div>
        <div class="ev-layer-body">
          <div class="file-tag">lib/age-utils.ts</div>
          <pre><span class="cm">// Fonctions calculateAgeAtDate + validateChildAge</span>
<span class="cm">// Pr√©sentes dans lib/age-utils.ts (docs/AGE_VALIDATION.md)</span>
<span class="cm">// Utilis√©es dans booking-modal.tsx pour feedback imm√©diat</span>
<span class="cm">// Calcul √¢ge = birthDate vs sessionStartDate (pas today)</span>

<span class="cm">// Verdict :</span>
<span class="cm">// ‚úÖ Validation GLOBALE (3-17) toujours c√¥t√© serveur</span>
<span class="cm">// ‚úÖ Validation S√âJOUR c√¥t√© client (feedback imm√©diat)</span>
<span class="cm">// ‚ö†Ô∏è Validation S√âJOUR c√¥t√© serveur conditionnelle (si age_min/max non null)</span>
<span class="cm">// ‚Üí Int√©grit√© d√©pend de la pr√©sence de age_min/age_max dans gd_stay_sessions</span></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="issue">
  <div class="issue-header">
    <div class="issue-num">D</div>
    <div class="issue-title">marketingTitle : bien prioritaire sur titleKids > title ?</div>
    <span class="issue-verdict iv-ok">‚úÖ CONFIRM√â LIGNE 92</span>
  </div>
  <div class="issue-body">
    <div class="ev-grid">
      <div class="ev-layer">
        <div class="ev-layer-head front-head">stay-detail.tsx L92 ‚Äî Affichage titre</div>
        <div class="ev-layer-body">
          <div class="file-tag">app/sejour/[id]/stay-detail.tsx</div><span class="line-tag">L91-92</span>
          <pre><span class="cm">// L91-92 ‚Äî TITRE H1 : CityCrunch UNIQUEMENT</span>
<span class="cm">// Plus aucun fallback vers titleKids ou title (anciens noms UFOVAL)</span>
<span class="kw">const</span> displayTitle =
  (stay <span class="kw">as any</span>)?.marketingTitle || <span class="str">'S√©jour'</span>;

<span class="cm">// Fallback = 'S√©jour' (g√©n√©rique) ‚Äî jamais un nom UFOVAL</span>
<span class="cm">// Correction appliqu√©e vs l'ancienne hi√©rarchie : marketingTitle > titleKids > title</span></pre>
        </div>
      </div>
      <div class="ev-layer">
        <div class="ev-layer-head bdd-head">Mapping Supabase ‚Üí camelCase</div>
        <div class="ev-layer-body">
          <div class="file-tag">lib/supabaseGed.ts</div><span class="line-tag">L56-74</span>
          <pre><span class="cm">// Mapping correct :</span>
marketingTitle: stay.marketing_title,
titleKids: stay.title_kids,
<span class="cm">// stay-detail.tsx L92 : utilise marketingTitle directement</span>
<span class="cm">// ‚Üí 24/24 s√©jours ont marketing_title non null (v√©rifi√©)</span>
<span class="cm">// ‚Üí 0 r√©gression d√©tect√©e c√¥t√© titre ‚úÖ</span>

<span class="cm">// reserver/page.tsx L65+71 : identique</span>
stay.marketingTitle || <span class="str">'S√©jour'</span>
<span class="cm">// ‚Üí Jamais affichage de noms UFOVAL ‚úÖ</span></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SYNTH√àSE -->
<div class="section-title" style="margin-top:28px;">üìä Synth√®se Delta ‚Äî UFOVAL vs Supabase vs Front GED</div>

<table class="delta-table" style="margin-bottom:20px;">
  <thead>
    <tr>
      <th>Anomalie</th>
      <th>Preuve BDD GED</th>
      <th>Preuve Front GED</th>
      <th>Reproductible</th>
      <th>Action requise</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Sessions manquantes GRAVITY BIKE PARK</strong><br><span style="font-size:10px; color:#64748b;">4 sessions absentes (12/07 7j, 02/08 7j, 14j, 21j)</span></td>
      <td class="cell-error">AUDIT_SESSION_2026-02-18.json<br>sessions_ufoval=12 vs sessions_bdd=8</td>
      <td class="cell-error">reserver/page.tsx L30-41<br>Sessions non affich√©es si absentes BDD</td>
      <td class="cell-error">‚úÖ Oui</td>
      <td>INSERT 4 sessions + corriger scraper n8n</td>
    </tr>
    <tr style="background:#fafbfc;">
      <td><strong>Off-by-one 14j/21j</strong><br><span style="font-size:10px; color:#64748b;">BDD stocke end_date - 1j vs UFOVAL</span></td>
      <td class="cell-warn">RAPPORT_CORRECTIONS_DUREES.md<br>Cause: scraper calcule nuits</td>
      <td class="cell-warn">stay-detail.tsx L196<br>Calcul correct (+1) mais donn√©es fausses</td>
      <td class="cell-warn">‚úÖ Oui</td>
      <td>SQL CORRECTION_SESSIONS_8_JOURS.sql (7/8 ex√©cut√©)</td>
    </tr>
    <tr>
      <td><strong>is_full d√©sync (5 sessions)</strong><br><span style="font-size:10px; color:#64748b;">Complet UFOVAL ‚â† is_full BDD</span></td>
      <td class="cell-error">sessions_complet_ufoval=7 vs bdd=2</td>
      <td class="cell-warn">supabaseGed.ts L74<br>isFull: stay.is_full ?? false</td>
      <td class="cell-warn">‚ö†Ô∏è Partiel (4 sessions absentes)</td>
      <td>Script resync is_full + workflow n8n</td>
    </tr>
    <tr style="background:#fafbfc;">
      <td><strong>Pricing 3 sessions Dest. Soleil</strong><br><span style="font-size:10px; color:#64748b;">1 row prix au lieu de ~19</span></td>
      <td class="cell-error">AUDIT_SESSION_2026-02-18.json<br>Anomalie document√©e</td>
      <td class="cell-error">pricing.ts L392<br>findSessionPrice ‚Üí null si ville absente<br>inscriptions/route.ts L106-137 ‚Üí PRICE_NOT_FOUND</td>
      <td class="cell-error">‚úÖ Oui ‚Äî inscription bloqu√©e</td>
      <td>R√©-import grille tarifaire 3 sessions</td>
    </tr>
    <tr>
      <td><strong>6j au lieu 7j MY LITTLE FOREST</strong><br><span style="font-size:10px; color:#64748b;">Session 6j stock√©e, UFOVAL = 7j</span></td>
      <td class="cell-warn">RAPPORT_CORRECTIONS_DUREES.md<br>SQL identifi√©, non ex√©cut√©</td>
      <td class="cell-warn">stay-detail.tsx L196<br>Affiche 6j au lieu de 7j</td>
      <td class="cell-ok">‚úÖ Oui</td>
      <td>Ex√©cuter CORRECTION_SESSION_6_JOURS_PTITS_PUISOTINS.sql</td>
    </tr>
    <tr style="background:#fafbfc;">
      <td><strong>validateChildAge serveur</strong><br><span style="font-size:10px; color:#64748b;">Conditionnel si age_min/max null BDD</span></td>
      <td class="cell-warn">inscriptions/route.ts L173<br>if (sessionRow && age_min !== null)</td>
      <td class="cell-ok">age-utils.ts ‚úÖ client<br>+ global 3-17 serveur ‚úÖ</td>
      <td class="cell-warn">‚ö†Ô∏è D√©pend de la BDD</td>
      <td>V√©rifier que age_min/age_max non null pour toutes sessions</td>
    </tr>
    <tr>
      <td><strong>marketingTitle prioritaire</strong></td>
      <td class="cell-ok">24/24 marketing_title non null</td>
      <td class="cell-ok">stay-detail.tsx L92<br>marketingTitle || 'S√©jour'</td>
      <td class="cell-ok">‚úÖ OK</td>
      <td class="cell-ok">Aucune action requise</td>
    </tr>
    <tr style="background:#fafbfc;">
      <td><strong>Prix bas√© sur dur√©e r√©elle session</strong></td>
      <td class="cell-ok">gd_session_prices match√©e par dates</td>
      <td class="cell-ok">pricing.ts L378-397<br>findSessionPrice(startDate, endDate)</td>
      <td class="cell-ok">‚úÖ OK</td>
      <td class="cell-ok">Aucune action requise</td>
    </tr>
  </tbody>
</table>

</main>

<footer>
  GED APP ‚Äî Preuves formelles c√¥t√© application ¬∑ 2026-02-18 ¬∑ READ-ONLY ¬∑ 0 patch appliqu√© ¬∑ Toutes preuves extraites du code source en session
</footer>

</body>
</html>
