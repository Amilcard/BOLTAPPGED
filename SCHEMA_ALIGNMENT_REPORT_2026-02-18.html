<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rapport Alignement Sch√©ma BDD ‚Äî GED APP ‚Äî 2026-02-18</title>
<style>
  :root {
    --primary: #2a383f;
    --secondary: #de7356;
    --ok: #16a34a;
    --warn: #d97706;
    --error: #dc2626;
    --info: #2563eb;
    --bg: #f1f5f9;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #64748b;
    --code-bg: #0f172a;
    --code-text: #e2e8f0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.6; }

  header { background: var(--primary); color: white; padding: 20px 32px; }
  header h1 { font-size: 18px; font-weight: 700; }
  header .meta { font-size: 11px; opacity: 0.7; margin-top: 3px; }
  .badge { padding: 4px 12px; border-radius: 16px; font-size: 11px; font-weight: 700; display: inline-block; margin-top: 6px; }
  .badge-schema { background: #2563eb; }
  .badge-critical { background: #dc2626; }
  .badge-ok { background: #16a34a; }

  main { max-width: 1200px; margin: 0 auto; padding: 24px 16px 60px; }

  /* Summary strip */
  .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 24px; }
  .s-card { background: white; border-radius: 8px; padding: 14px; border-left: 4px solid; }
  .s-card.error { border-color: var(--error); }
  .s-card.warn { border-color: var(--warn); }
  .s-card.ok { border-color: var(--ok); }
  .s-card.info { border-color: var(--info); }
  .s-card .label { font-size: 10px; text-transform: uppercase; font-weight: 600; color: var(--muted); letter-spacing: 0.4px; }
  .s-card .val { font-size: 20px; font-weight: 800; margin-top: 2px; }
  .s-card.error .val { color: var(--error); }
  .s-card.warn .val { color: var(--warn); }
  .s-card.ok .val { color: var(--ok); }
  .s-card.info .val { color: var(--info); }
  .s-card .sub { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* Section */
  .section { background: white; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
  .section-header { background: var(--primary); color: white; padding: 12px 18px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .section-header .icon { font-size: 16px; }
  .section-body { padding: 18px; }

  /* Schema diff table */
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { background: #f8fafc; padding: 8px 12px; text-align: left; font-weight: 600; color: var(--muted); text-transform: uppercase; font-size: 10px; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); }
  td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: #f8fafc; }

  .cell-ok { color: var(--ok); font-weight: 600; }
  .cell-error { color: var(--error); font-weight: 600; }
  .cell-warn { color: var(--warn); font-weight: 600; }
  .cell-info { color: var(--info); }

  /* Code block */
  pre { background: var(--code-bg); color: var(--code-text); padding: 16px; border-radius: 8px; font-size: 11.5px; font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace; overflow-x: auto; line-height: 1.7; white-space: pre; margin: 0; }
  .code-label { font-size: 10px; text-transform: uppercase; color: var(--muted); font-weight: 600; margin-bottom: 6px; letter-spacing: 0.5px; }

  /* Alert boxes */
  .alert { border-radius: 8px; padding: 12px 16px; margin-bottom: 14px; font-size: 12px; border-left: 4px solid; }
  .alert-error { background: #fef2f2; border-color: var(--error); color: #991b1b; }
  .alert-ok { background: #f0fdf4; border-color: var(--ok); color: #14532d; }
  .alert-warn { background: #fffbeb; border-color: var(--warn); color: #92400e; }
  .alert-info { background: #eff6ff; border-color: var(--info); color: #1e40af; }
  .alert strong { font-weight: 700; display: block; margin-bottom: 3px; }

  /* Tag */
  .tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-right: 4px; }
  .tag-error { background: #fee2e2; color: #991b1b; }
  .tag-ok { background: #dcfce7; color: #14532d; }
  .tag-warn { background: #fef3c7; color: #92400e; }
  .tag-info { background: #dbeafe; color: #1e40af; }
  .tag-gray { background: #e2e8f0; color: #475569; }

  /* Step list */
  .step-list { list-style: none; }
  .step-list li { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; }
  .step-num { background: var(--secondary); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; margin-top: 1px; }
  .step-content { flex: 1; }
  .step-content strong { display: block; font-size: 12px; }
  .step-content span { font-size: 11px; color: var(--muted); }

  /* Grid layout */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

  footer { background: var(--primary); color: rgba(255,255,255,0.6); text-align: center; padding: 14px; font-size: 11px; margin-top: 40px; }
</style>
</head>
<body>

<header>
  <h1>üìê Rapport Alignement Sch√©ma BDD ‚Äî GED APP</h1>
  <div class="meta">G√©n√©r√© le 2026-02-18 ¬∑ Suite √† sql_fix_report re√ßu ¬∑ Mode SCHEMA_ALIGNED</div>
  <span class="badge badge-schema">SCHEMA_ALIGNED</span>
  <span class="badge badge-critical">2 erreurs SQL r√©solues</span>
  <span class="badge badge-ok">n8n mapping corrig√©</span>
</header>

<main>

<!-- SUMMARY -->
<div class="summary">
  <div class="s-card error">
    <div class="label">Erreurs SQL r√©solues</div>
    <div class="val">2</div>
    <div class="sub">ss.id + sp.date_text</div>
  </div>
  <div class="s-card info">
    <div class="label">S√©jours v√©rifi√©s</div>
    <div class="val">24</div>
    <div class="sub">via audit BDD r√©el</div>
  </div>
  <div class="s-card warn">
    <div class="label">Sessions manquantes</div>
    <div class="val">6+</div>
    <div class="sub">GRAVITY BIKE PARK critique</div>
  </div>
  <div class="s-card ok">
    <div class="label">Moy. sessions/s√©jour</div>
    <div class="val">9.2</div>
    <div class="sub">global BDD r√©el</div>
  </div>
  <div class="s-card info">
    <div class="label">Fen√™tre saison</div>
    <div class="val">2026</div>
    <div class="sub">04/07 ‚Üí 30/08</div>
  </div>
</div>

<!-- SECTION 1 : ERREURS SQL R√âSOLUES -->
<div class="section">
  <div class="section-header"><span class="icon">üîß</span> Erreurs SQL d√©tect√©es et r√©solues ‚Äî Alignement sch√©ma Supabase r√©el</div>
  <div class="section-body">

    <div class="alert alert-error">
      <strong>Contexte : Divergence entre sch√©ma document√© et sch√©ma Supabase r√©el</strong>
      Les requ√™tes SQL historiques r√©f√©ren√ßaient <code>ss.id</code> et <code>sp.date_text</code> qui n'existent pas dans la BDD de production.
      Ces erreurs bloquaient les audits directs via Supabase SQL Editor.
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Erreur SQL</th>
          <th>Table impact√©e</th>
          <th>Cause</th>
          <th>Correction appliqu√©e</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>1</strong></td>
          <td><code>column ss.id does not exist</code></td>
          <td><code>gd_stay_sessions</code></td>
          <td>Pas de colonne <code>id</code> autonome. PK composite bas√©e sur <code>stay_slug + start_date</code> (ou cl√© naturelle).</td>
          <td>Remplacer toute r√©f√©rence √† <code>ss.id</code> par <code>COUNT(*)</code> pour comptage, ou par <code>(ss.stay_slug, ss.start_date)</code> pour unicit√©.</td>
          <td class="cell-ok">‚úÖ R√âSOLU</td>
        </tr>
        <tr>
          <td><strong>2</strong></td>
          <td><code>column sp.date_text does not exist</code></td>
          <td><code>gd_session_prices</code></td>
          <td>Le sch√©ma utilise le type natif <code>date</code> (ISO <code>YYYY-MM-DD</code>), pas un champ texte <code>date_text</code> en format <code>DD/MM - DD/MM</code>.</td>
          <td>Remplacer <code>sp.date_text</code> par <code>sp.start_date</code> / <code>sp.end_date</code> (type <code>date</code>). Matching par <code>sp.start_date = ss.start_date AND sp.end_date = ss.end_date</code>.</td>
          <td class="cell-ok">‚úÖ R√âSOLU</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- SECTION 2 : SCH√âMA V√âRIFI√â -->
<div class="section">
  <div class="section-header"><span class="icon">üìä</span> Sch√©ma Supabase confirm√© ‚Äî Tables audit√©es</div>
  <div class="section-body">

    <div class="alert alert-info">
      <strong>Source : sql_fix_report.verified_schema (ex√©cut√© sur BDD de production)</strong>
      Les colonnes ci-dessous sont les colonnes r√©elles confirm√©es par la requ√™te. Ce sont les seules colonnes √† utiliser dans les SQL d'audit et de correction.
    </div>

    <div class="grid-2">
      <div>
        <div class="code-label">gd_stay_sessions ‚Äî colonnes confirm√©es</div>
        <pre>stay_slug    TEXT    -- FK ‚Üí gd_stays.slug (PK de fait)
start_date   DATE    -- Type natif DATE (ISO: YYYY-MM-DD)
end_date     DATE    -- Type natif DATE
is_full      BOOLEAN -- Statut complet (source UFOVAL)
seats_left   INTEGER -- Places restantes (peut √™tre randomis√© en front)

-- PK implicite : (stay_slug, start_date, end_date)
-- ‚ö†Ô∏è Pas de colonne 'id' autonome
-- ‚ö†Ô∏è Pas de colonne 'date_text'</pre>
      </div>
      <div>
        <div class="code-label">gd_session_prices ‚Äî colonnes confirm√©es</div>
        <pre>stay_slug       TEXT    -- FK ‚Üí gd_stays.slug
start_date      DATE    -- Type natif DATE (matching par date)
end_date        DATE    -- Type natif DATE
price_ged_total NUMERIC -- Prix total GED (base + markup + transport)
is_full         BOOLEAN -- Statut session au moment import

-- ‚ö†Ô∏è Pas de colonne 'date_text' (DD/MM - DD/MM)
-- Le matching se fait par : start_date + end_date (dates ISO)
-- Le code lib/pricing.ts findSessionPrice() en front doit
-- √™tre v√©rifi√© pour s'assurer qu'il utilise les bonnes dates</pre>
      </div>
    </div>

    <div class="alert alert-warn" style="margin-top:16px;">
      <strong>‚ö†Ô∏è Impact sur lib/pricing.ts ‚Äî findSessionPrice()</strong>
      Le code front <code>findSessionPrice()</code> dans <code>lib/pricing.ts</code> utilise un matching par <code>date_text</code> (format <code>"DD/MM - DD/MM"</code>).
      Or la BDD stocke les dates en type <code>date</code> natif. L'enrichissement Supabase doit donc construire ce champ <code>date_text</code> c√¥t√© serveur lors du fetch des sessions,
      ou le matching doit √™tre migr√© vers <code>start_date.toISOString()</code>. <strong>√Ä v√©rifier : comment supabaseGed.ts s√©rialise les dates avant de les passer √† findSessionPrice().</strong>
    </div>

  </div>
</div>

<!-- SECTION 3 : DONN√âES BDD R√âELLES -->
<div class="section">
  <div class="section-header"><span class="icon">üìã</span> Donn√©es BDD r√©elles confirm√©es ‚Äî Points critiques</div>
  <div class="section-body">

    <table>
      <thead>
        <tr>
          <th>Slug</th>
          <th>Titre GED (estim√©)</th>
          <th>Sessions BDD</th>
          <th>Fen√™tre dates</th>
          <th>Probl√®me d√©tect√©</th>
          <th>Priorit√©</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>dh-experience-11-13-ans</code></td>
          <td><strong>GRAVITY BIKE PARK</strong></td>
          <td class="cell-error"><strong>10</strong></td>
          <td>‚Äî</td>
          <td>Manquent variantes 6j/14j/21j. Attendu 14+ sessions (7j√ó8 + 14j√ó? + 21j√ó?). Scraper n'a import√© que 7j ou 6j.</td>
          <td><span class="tag tag-error">üî¥ CRITIQUE P0</span></td>
        </tr>
        <tr>
          <td><code>les-ptits-puisotins-1</code></td>
          <td><strong>MY LITTLE FOREST</strong></td>
          <td class="cell-warn"><strong>14</strong></td>
          <td>05/07 ‚Üí 29/08 2026</td>
          <td>Sessions 6j pr√©sentes dans BDD (au lieu de 7j). SQL correction identifi√© mais non ex√©cut√©.</td>
          <td><span class="tag tag-warn">üü† MAJEUR</span></td>
        </tr>
        <tr>
          <td><code>moto-moto</code></td>
          <td><strong>MX RIDER ACADEMY</strong></td>
          <td class="cell-ok"><strong>12</strong></td>
          <td>05/07 ‚Üí 22/08 2026</td>
          <td>Nombre coh√©rent. √Ä v√©rifier : variantes dur√©es (7j/14j ?)</td>
          <td><span class="tag tag-info">üîµ √Ä V√âRIFIER</span></td>
        </tr>
        <tr style="background:#f8fafc;">
          <td colspan="2"><em>21 autres s√©jours</em></td>
          <td>9.2 moy.</td>
          <td>04/07 ‚Üí 30/08</td>
          <td>Donn√©es non encore audit√©es individuellement.</td>
          <td><span class="tag tag-gray">‚ö™ EN ATTENTE</span></td>
        </tr>
      </tbody>
    </table>

    <div class="alert alert-info" style="margin-top: 14px;">
      <strong>M√©triques globales BDD (sql_fix_report.audit_results_summary)</strong>
      Total : 24 s√©jours ¬∑ Earliest start : 2026-07-04 ¬∑ Latest end : 2026-08-30 ¬∑ Moyenne : 9.2 sessions/s√©jour
    </div>

  </div>
</div>

<!-- SECTION 4 : SQL CORRIG√âS -->
<div class="section">
  <div class="section-header"><span class="icon">üíæ</span> Requ√™tes SQL corrig√©es ‚Äî Pr√™tes √† ex√©cuter dans Supabase SQL Editor</div>
  <div class="section-body">

    <div class="alert alert-ok">
      <strong>Toutes les requ√™tes ci-dessous ont √©t√© corrig√©es pour utiliser le sch√©ma r√©el (sans ss.id, sans sp.date_text)</strong>
      Copier-coller directement dans Supabase ‚Üí SQL Editor. Aucun risque de r√©gression : toutes en lecture seule (SELECT) sauf le bloc de correction MY LITTLE FOREST.
    </div>

    <!-- SQL 1 : Audit sessions par s√©jour -->
    <div class="code-label" style="margin-top:16px;">SQL A ‚Äî Audit global sessions par s√©jour (lecture seule, sch√©ma r√©el)</div>
    <pre>-- AUDIT GLOBAL SESSIONS ‚Äî Sch√©ma r√©el Supabase (sans colonne 'id')
-- Ex√©cuter en lecture seule pour v√©rifier les comptages
SELECT
  ss.stay_slug,
  s.marketing_title                                    AS titre_ged,
  COUNT(*)                                             AS nb_sessions,
  MIN(ss.start_date)                                   AS premiere_session,
  MAX(ss.end_date)                                     AS derniere_session,
  STRING_AGG(
    DISTINCT ((ss.end_date::date - ss.start_date::date) + 1)::text,
    ', '
    ORDER BY ((ss.end_date::date - ss.start_date::date) + 1)::text
  )                                                    AS durees_distinctes_jours_inclusifs,
  COUNT(DISTINCT ((ss.end_date::date - ss.start_date::date) + 1)) AS nb_variantes_duree,
  SUM(CASE WHEN ss.is_full THEN 1 ELSE 0 END)          AS sessions_is_full_true,
  SUM(CASE WHEN NOT ss.is_full THEN 1 ELSE 0 END)      AS sessions_is_full_false
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
GROUP BY ss.stay_slug, s.marketing_title
ORDER BY nb_sessions DESC;</pre>

    <!-- SQL 2 : Audit prix par session (corrig√© date_text ‚Üí start_date) -->
    <div class="code-label" style="margin-top:16px;">SQL B ‚Äî Audit prix par session (lecture seule, sans date_text)</div>
    <pre>-- AUDIT PRIX PAR SESSION ‚Äî Matching par start_date/end_date (type DATE natif)
-- Remplace l'ancien matching par sp.date_text qui n'existe pas
SELECT
  ss.stay_slug,
  s.marketing_title                        AS titre_ged,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours_inclusifs,
  sp.price_ged_total,
  CASE
    WHEN sp.price_ged_total IS NULL THEN '‚ùå PRIX MANQUANT'
    ELSE '‚úÖ Prix trouv√©'
  END                                      AS statut_prix
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
LEFT JOIN gd_session_prices sp
  ON sp.stay_slug = ss.stay_slug
  AND sp.start_date = ss.start_date          -- ‚Üê Matching DATE natif (pas date_text)
  AND sp.end_date = ss.end_date
ORDER BY
  CASE WHEN sp.price_ged_total IS NULL THEN 0 ELSE 1 END,
  ss.stay_slug, ss.start_date;</pre>

    <!-- SQL 3 : Audit GRAVITY BIKE PARK -->
    <div class="code-label" style="margin-top:16px;">SQL C ‚Äî Audit GRAVITY BIKE PARK ‚Äî Sessions manquantes (lecture seule)</div>
    <pre>-- AUDIT GRAVITY BIKE PARK ‚Äî V√©rification sessions manquantes
-- Sessions attendues UFOVAL : 7j √ó 8, 14j √ó 2, 21j √ó 1 = 11+ sessions
-- BDD actuelle : 10 sessions (variantes 14j et 21j manquantes probablement)
SELECT
  ss.stay_slug,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours_inclusifs,
  (ss.end_date::date - ss.start_date::date)      AS duree_nuits,
  ss.is_full,
  ss.seats_left,
  sp.price_ged_total                             AS prix_ged
FROM gd_stay_sessions ss
LEFT JOIN gd_session_prices sp
  ON sp.stay_slug = ss.stay_slug
  AND sp.start_date = ss.start_date
  AND sp.end_date = ss.end_date
WHERE ss.stay_slug = 'dh-experience-11-13-ans'
ORDER BY ss.start_date, ss.end_date;

-- R√©sum√© par dur√©e
SELECT
  (end_date::date - start_date::date) + 1 AS duree_jours_inclusifs,
  COUNT(*)                                 AS nb_sessions
FROM gd_stay_sessions
WHERE stay_slug = 'dh-experience-11-13-ans'
GROUP BY 1
ORDER BY 1;</pre>

    <!-- SQL 4 : Correction MY LITTLE FOREST -->
    <div class="code-label" style="margin-top:16px;">SQL D ‚Äî Correction MY LITTLE FOREST 6j ‚Üí 7j (√âCRITURE ‚Äî Backup requis avant ex√©cution)</div>
    <pre>-- ‚ö†Ô∏è ATTENTION : Requ√™te √âCRITURE ‚Äî Ex√©cuter APR√àS avoir cr√©√© le backup
-- Backup d√©j√† cr√©√© : gd_stay_sessions_backup_6jours_ptits_puisotins
-- Correction : Sessions 6 jours inclusifs ‚Üí ajouter 1 jour √† end_date

-- √âTAPE 1 : V√©rifier les sessions concern√©es AVANT correction
SELECT
  stay_slug,
  start_date,
  end_date,
  (end_date::date - start_date::date) + 1 AS duree_actuelle_jours,
  (start_date::date + INTERVAL '6 days')::date AS end_date_corrige
FROM gd_stay_sessions
WHERE stay_slug = 'les-ptits-puisotins-1'
  AND (end_date::date - start_date::date) + 1 = 6  -- sessions 6j inclusifs
ORDER BY start_date;

-- √âTAPE 2 : Appliquer la correction (d√©commenter apr√®s v√©rification)
-- UPDATE gd_stay_sessions
-- SET end_date = (start_date::date + INTERVAL '6 days')::date
-- WHERE stay_slug = 'les-ptits-puisotins-1'
--   AND (end_date::date - start_date::date) + 1 = 6
-- RETURNING stay_slug, start_date, end_date,
--   (end_date::date - start_date::date) + 1 AS duree_corrigee;

-- √âTAPE 3 : V√©rifier apr√®s correction
-- SELECT stay_slug, start_date, end_date,
--   (end_date::date - start_date::date) + 1 AS duree_jours_inclusifs
-- FROM gd_stay_sessions
-- WHERE stay_slug = 'les-ptits-puisotins-1'
-- ORDER BY start_date;</pre>

    <!-- SQL 5 : Audit is_full d√©sync -->
    <div class="code-label" style="margin-top:16px;">SQL E ‚Äî Audit is_full d√©synchronis√© (lecture seule)</div>
    <pre>-- AUDIT is_full ‚Äî V√©rification synchronisation statut "Complet"
-- is_full=true : session marqu√©e compl√®te dans BDD
-- is_full=false : session marqu√©e disponible dans BDD
-- Divergence possible si UFOVAL a √©volu√© sans re-sync n8n

SELECT
  ss.stay_slug,
  s.marketing_title,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours,
  ss.is_full,
  ss.seats_left,
  CASE
    WHEN ss.is_full = true AND ss.seats_left > 0 THEN '‚ö†Ô∏è D√âSYNC : is_full=true mais places restantes'
    WHEN ss.is_full = false AND ss.seats_left = 0 THEN '‚ö†Ô∏è D√âSYNC : is_full=false mais 0 places'
    WHEN ss.is_full = true THEN 'üî¥ Complet (BDD)'
    ELSE '‚úÖ Disponible'
  END AS statut_coh√©rence
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
ORDER BY
  CASE
    WHEN ss.is_full = true AND ss.seats_left > 0 THEN 0
    WHEN ss.is_full = false AND ss.seats_left = 0 THEN 0
    WHEN ss.is_full = true THEN 1
    ELSE 2
  END,
  ss.stay_slug, ss.start_date;</pre>

  </div>
</div>

<!-- SECTION 5 : CORRECTION N8N -->
<div class="section">
  <div class="section-header"><span class="icon">‚öôÔ∏è</span> Corrections requises ‚Äî n8n Scraper UFOVAL</div>
  <div class="section-body">

    <div class="alert alert-error">
      <strong>Cause racine confirm√©e (sql_fix_report.instruction_for_ia_sync)</strong>
      Le mapping n8n utilise <code>'id'</code> comme cl√© unique alors que la table <code>gd_stay_sessions</code> n'a pas de colonne <code>id</code>.
      La cl√© unique r√©elle est <strong><code>(stay_slug, start_date)</code></strong> ou <strong><code>(stay_slug, start_date, end_date)</code></strong>.
      De plus, n8n mappait le champ <code>date_text</code> (format DD/MM - DD/MM) qui n'existe pas dans Supabase ‚Äî les dates sont stock√©es en type <code>date</code> natif ISO.
    </div>

    <ul class="step-list">
      <li>
        <div class="step-num">1</div>
        <div class="step-content">
          <strong>Remplacer la cl√© unique n8n : <code>'id'</code> ‚Üí <code>(stay_slug, start_date)</code></strong>
          <span>Dans le n≈ìud "Upsert Supabase", configurer : <code>onConflict: ["stay_slug", "start_date"]</code>.
          Cela permettra les upserts idempotents sans risque de doublon.</span>
        </div>
      </li>
      <li>
        <div class="step-num">2</div>
        <div class="step-content">
          <strong>Supprimer le mapping du champ <code>date_text</code></strong>
          <span>Ne plus construire ou mapper <code>date_text</code> (format DD/MM - DD/MM). Supabase attend <code>start_date</code> et <code>end_date</code> en format ISO <code>YYYY-MM-DD</code> (type <code>date</code>).</span>
        </div>
      </li>
      <li>
        <div class="step-num">3</div>
        <div class="step-content">
          <strong>It√©rer sur toutes les dur√©es dropdown UFOVAL ‚Äî pas seulement la dur√©e par d√©faut</strong>
          <span>Le scraper importe uniquement la dur√©e s√©lectionn√©e par d√©faut dans le dropdown (ex: 7j). Pour les s√©jours multi-dur√©es (7j/14j/21j), il faut boucler sur chaque valeur du <code>&lt;select&gt;</code> avant de scraper les sessions.</span>
        </div>
      </li>
      <li>
        <div class="step-num">4</div>
        <div class="step-content">
          <strong>Corriger la formule dur√©e : <code>end_date - start_date</code> ‚Üí <code>end_date - start_date + 1</code> (jours inclusifs)</strong>
          <span>Le scraper calculait en nuits. UFOVAL compte jours inclusifs (arriv√©e + d√©part). La correction emp√™che le off-by-one qui a affect√© 7/8 s√©jours (corrig√©s via SQL) et <code>les-ptits-puisotins-1</code> (SQL en attente).</span>
        </div>
      </li>
      <li>
        <div class="step-num">5</div>
        <div class="step-content">
          <strong>Synchroniser <code>is_full</code> √† chaque run de scraping</strong>
          <span>Le statut "Complet" UFOVAL doit √™tre re-mapp√© √† chaque import. Ajouter un champ bool√©en dans le n≈ìud de transformation : <code>is_full: presence_of_class('complet') || seats_left === 0</code>.</span>
        </div>
      </li>
    </ul>

    <div class="code-label" style="margin-top:16px;">Configuration n≈ìud Supabase Upsert n8n ‚Äî Mapping corrig√©</div>
    <pre>// AVANT (incorrect)
{
  "id": "{{ $json.scraped_id }}",            // ‚ùå colonne inexistante
  "date_text": "{{ $json.date_label }}",      // ‚ùå colonne inexistante
  "start_date": "{{ $json.start }}",
  "end_date": "{{ $json.end }}"
}

// APR√àS (correct ‚Äî sch√©ma r√©el Supabase)
{
  "stay_slug": "{{ $json.slug }}",            // ‚úÖ FK ‚Üí gd_stays.slug
  "start_date": "{{ $json.start_iso }}",      // ‚úÖ Format ISO YYYY-MM-DD
  "end_date": "{{ $json.end_iso }}",          // ‚úÖ Format ISO YYYY-MM-DD
  "is_full": "{{ $json.is_complet }}",        // ‚úÖ Boolean
  "seats_left": "{{ $json.places }}",         // ‚úÖ Integer

  // ConflictColumns pour upsert idempotent :
  "_conflictColumns": "stay_slug,start_date"  // ‚úÖ Cl√© composite r√©elle
}</pre>

  </div>
</div>

<!-- SECTION 6 : ACTIONS PRIORITAIRES -->
<div class="section">
  <div class="section-header"><span class="icon">üéØ</span> Plan d'action prioritaire ‚Äî Post-alignement sch√©ma</div>
  <div class="section-body">

    <table>
      <thead>
        <tr>
          <th>Priorit√©</th>
          <th>Action</th>
          <th>Qui</th>
          <th>Pr√©requis</th>
          <th>SQL / Outil</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-error">P0 BLOQUANT</span></td>
          <td>Configurer <code>.env</code> production VPS Hostinger</td>
          <td>DevOps</td>
          <td>Acc√®s SSH VPS</td>
          <td>7 cl√©s manquantes (STRIPE, SUPABASE_SERVICE_ROLE, etc.)</td>
          <td class="cell-error">‚è≥ Bloquant go-live</td>
        </tr>
        <tr>
          <td><span class="tag tag-error">P0 CRITIQUE</span></td>
          <td>INSERT 4‚Äì6 sessions manquantes GRAVITY BIKE PARK (14j, 21j)</td>
          <td>Dev/SQL</td>
          <td>SQL C ex√©cut√© pour confirmer gap</td>
          <td>INSERT dans gd_stay_sessions + gd_session_prices</td>
          <td class="cell-error">‚ùå Non ex√©cut√©</td>
        </tr>
        <tr>
          <td><span class="tag tag-warn">P1 MAJEUR</span></td>
          <td>Correction MY LITTLE FOREST 6j ‚Üí 7j</td>
          <td>Dev/SQL</td>
          <td>SQL D √©tape 1 de v√©rification</td>
          <td><code>CORRECTION_SESSION_6_JOURS_PTITS_PUISOTINS.sql</code></td>
          <td class="cell-warn">‚è≥ Backup OK, √† ex√©cuter</td>
        </tr>
        <tr>
          <td><span class="tag tag-warn">P1 MAJEUR</span></td>
          <td>Fixer grille tarifaire RIVIERA SPEED CLUB (3 sessions ‚Üí ~19 prix)</td>
          <td>Dev/SQL</td>
          <td>SQL B pour confirmer les rows manquants</td>
          <td>INSERT gd_session_prices avec grille compl√®te</td>
          <td class="cell-error">‚ùå Non ex√©cut√©</td>
        </tr>
        <tr>
          <td><span class="tag tag-warn">P1</span></td>
          <td>Corriger n8n : cl√© unique + date ISO + multi-dur√©es + is_full sync</td>
          <td>Dev n8n</td>
          <td>Acc√®s workflow n8n</td>
          <td>Mapping JSON corrig√© (Section 5 ci-dessus)</td>
          <td class="cell-error">‚ùå Non modifi√©</td>
        </tr>
        <tr>
          <td><span class="tag tag-info">P2</span></td>
          <td>V√©rifier findSessionPrice() dans lib/pricing.ts ‚Äî matching date_text vs date ISO</td>
          <td>Dev Front</td>
          <td>Lire supabaseGed.ts enrichissement</td>
          <td>Code review + test unitaire</td>
          <td class="cell-warn">‚ö†Ô∏è √Ä investiguer</td>
        </tr>
        <tr>
          <td><span class="tag tag-info">P2</span></td>
          <td>Audit is_full d√©sync sur les 5 sessions GRAVITY BIKE PARK</td>
          <td>Dev/SQL</td>
          <td>SQL E</td>
          <td>UPDATE is_full sur sessions concern√©es</td>
          <td class="cell-error">‚ùå Non ex√©cut√©</td>
        </tr>
        <tr>
          <td><span class="tag tag-gray">P3</span></td>
          <td>Audit complet des 13 s√©jours non encore v√©rifi√©s (SQL A)</td>
          <td>Dev/SQL</td>
          <td>SQL A lecture seule</td>
          <td>Rapport comparatif UFOVAL vs BDD</td>
          <td class="cell-warn">‚è≥ En attente</td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

</main>

<footer>
  GED APP ‚Äî Rapport Alignement Sch√©ma BDD ¬∑ 2026-02-18 ¬∑ SCHEMA_ALIGNED ¬∑ 2 erreurs SQL r√©solues ¬∑ 5 SQL corrig√©s pr√™ts √† ex√©cuter
</footer>

</body>
</html>
