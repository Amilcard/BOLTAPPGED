<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow Ma√Ætre ‚Äî GED APP ‚Äî ALIGNMENT_PROTOCOL_ACTIVE ‚Äî 2026-02-18</title>
<style>
  :root {
    --primary: #1e2d3a;
    --accent: #de7356;
    --ok: #16a34a;
    --warn: #d97706;
    --error: #dc2626;
    --info: #2563eb;
    --bg: #f0f4f8;
    --card: #ffffff;
    --border: #dde3ea;
    --text: #1e293b;
    --muted: #64748b;
    --code-bg: #0f172a;
    --code-text: #e2e8f0;
    --phase1: #7c3aed;
    --phase2: #0891b2;
    --phase3: #059669;
    --phase4: #d97706;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.6; }

  header { background: var(--primary); color: white; padding: 22px 36px; }
  header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.3px; }
  header .sub { font-size: 12px; opacity: 0.65; margin-top: 4px; }
  .header-badges { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
  .hbadge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .hb-active { background: #7c3aed; }
  .hb-mode { background: var(--info); }
  .hb-seq { background: #059669; }

  main { max-width: 1300px; margin: 0 auto; padding: 28px 18px 70px; }

  /* Strategy flow visual */
  .strategy-flow { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 22px; margin-bottom: 28px; }
  .strategy-flow h2 { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }
  .flow-steps { display: flex; align-items: center; gap: 0; flex-wrap: wrap; }
  .flow-step { flex: 1; min-width: 180px; padding: 14px 18px; border-radius: 8px; position: relative; }
  .flow-step.p1 { background: #f5f3ff; border: 2px solid var(--phase1); }
  .flow-step.p2 { background: #ecfeff; border: 2px solid var(--phase2); }
  .flow-step.p3 { background: #f0fdf4; border: 2px solid var(--phase3); }
  .flow-step.p4 { background: #fffbeb; border: 2px solid var(--phase4); }
  .flow-step .step-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .p1 .step-label { color: var(--phase1); }
  .p2 .step-label { color: var(--phase2); }
  .p3 .step-label { color: var(--phase3); }
  .p4 .step-label { color: var(--phase4); }
  .flow-step .step-title { font-size: 13px; font-weight: 800; }
  .flow-step .step-desc { font-size: 11px; color: var(--muted); margin-top: 3px; }
  .flow-step .blocker { font-size: 10px; font-weight: 700; background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 8px; margin-top: 6px; display: inline-block; }
  .flow-step .prereq { font-size: 10px; font-weight: 700; background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 8px; margin-top: 6px; display: inline-block; }
  .flow-arrow { font-size: 22px; color: var(--muted); padding: 0 10px; flex-shrink: 0; }

  /* Section headers */
  .section { background: white; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 22px; overflow: hidden; }
  .section-hdr { padding: 14px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
  .section-hdr .phase-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
  .ph1 { background: var(--phase1); }
  .ph2 { background: var(--phase2); }
  .ph3 { background: var(--phase3); }
  .ph4 { background: var(--phase4); }
  .section-hdr h3 { font-size: 14px; font-weight: 700; }
  .section-hdr .phase-tag { font-size: 10px; font-weight: 700; padding: 2px 10px; border-radius: 12px; margin-left: auto; }
  .section-body { padding: 20px; }

  /* Grid stays */
  .stays-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 10px; }
  .stay-card { border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: #fafbfc; }
  .stay-card .sc-slug { font-size: 10px; font-family: Consolas, monospace; color: var(--muted); }
  .stay-card .sc-name { font-size: 12px; font-weight: 700; margin: 2px 0; }
  .stay-card .sc-ufoval { font-size: 11px; color: var(--muted); }
  .stay-card .sc-checks { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; }
  .check { font-size: 10px; padding: 2px 7px; border-radius: 8px; font-weight: 600; }
  .c-ok { background: #dcfce7; color: #14532d; }
  .c-warn { background: #fef3c7; color: #92400e; }
  .c-error { background: #fee2e2; color: #991b1b; }
  .c-pending { background: #e2e8f0; color: #475569; }
  .c-info { background: #dbeafe; color: #1e40af; }

  /* Universe headers */
  .univ-hdr { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin: 16px 0 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }

  /* Table */
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  th { background: #f8fafc; padding: 8px 12px; text-align: left; font-weight: 600; color: var(--muted); text-transform: uppercase; font-size: 10px; letter-spacing: 0.4px; border-bottom: 2px solid var(--border); }
  td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: #f8fafc; }
  .cell-ok { color: var(--ok); font-weight: 600; }
  .cell-error { color: var(--error); font-weight: 600; }
  .cell-warn { color: var(--warn); font-weight: 600; }

  /* Code block */
  pre { background: var(--code-bg); color: var(--code-text); padding: 16px; border-radius: 8px; font-size: 11.5px; font-family: 'Cascadia Code', 'Fira Code', Consolas, monospace; overflow-x: auto; line-height: 1.7; white-space: pre; margin: 0; }
  .code-label { font-size: 10px; text-transform: uppercase; color: var(--muted); font-weight: 600; margin-bottom: 6px; letter-spacing: 0.5px; }

  /* Alert */
  .alert { border-radius: 8px; padding: 12px 16px; margin-bottom: 14px; font-size: 12px; border-left: 4px solid; }
  .alert-error { background: #fef2f2; border-color: var(--error); color: #991b1b; }
  .alert-ok { background: #f0fdf4; border-color: var(--ok); color: #14532d; }
  .alert-warn { background: #fffbeb; border-color: var(--warn); color: #92400e; }
  .alert-info { background: #eff6ff; border-color: var(--info); color: #1e40af; }
  .alert strong { font-weight: 700; display: block; margin-bottom: 3px; }

  /* Key rules box */
  .rules-box { background: var(--primary); color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
  .rules-box h3 { font-size: 13px; font-weight: 700; margin-bottom: 14px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; }
  .rule-item { display: flex; gap: 12px; margin-bottom: 10px; align-items: flex-start; }
  .rule-num { background: var(--accent); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; flex-shrink: 0; margin-top: 1px; }
  .rule-text strong { display: block; font-size: 12px; color: white; }
  .rule-text span { font-size: 11px; color: rgba(255,255,255,0.65); }

  /* Checklist */
  .checklist { list-style: none; }
  .checklist li { display: flex; gap: 10px; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .checklist li:last-child { border-bottom: none; }
  .cl-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }
  .cl-text strong { display: block; font-weight: 600; }
  .cl-text span { font-size: 11px; color: var(--muted); }

  /* Grid 2 */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media(max-width:768px){ .grid-2{grid-template-columns:1fr;} }

  /* Status badges */
  .tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; margin-right: 4px; }
  .tag-error { background: #fee2e2; color: #991b1b; }
  .tag-ok { background: #dcfce7; color: #14532d; }
  .tag-warn { background: #fef3c7; color: #92400e; }
  .tag-info { background: #dbeafe; color: #1e40af; }
  .tag-purple { background: #f5f3ff; color: #6d28d9; }
  .tag-gray { background: #e2e8f0; color: #475569; }

  footer { background: var(--primary); color: rgba(255,255,255,0.55); text-align: center; padding: 14px; font-size: 11px; margin-top: 40px; }
</style>
</head>
<body>

<header>
  <h1>‚öôÔ∏è Workflow Ma√Ætre GED APP ‚Äî ALIGNMENT_PROTOCOL_ACTIVE</h1>
  <div class="sub">Strategy flow s√©quentiel bloquant ¬∑ 24 s√©jours ¬∑ 4 univers ¬∑ Sch√©ma Supabase r√©el ¬∑ 2026-02-18</div>
  <div class="header-badges">
    <span class="hbadge hb-active">ALIGNMENT_PROTOCOL_ACTIVE</span>
    <span class="hbadge hb-mode">economy_secure_no_regression</span>
    <span class="hbadge hb-seq">4 phases s√©quentielles</span>
  </div>
</header>

<main>

<!-- STRATEGY FLOW VISUAL -->
<div class="strategy-flow">
  <h2>üîÅ Strategy Flow ‚Äî Pr√©alable Bloquant ‚Üí Go-Live</h2>
  <div class="flow-steps">
    <div class="flow-step p1">
      <div class="step-label">Phase 1 ‚Äî PR√âALABLE BLOQUANT</div>
      <div class="step-title">‚úÖ Validation Audit</div>
      <div class="step-desc">V√©rification manuelle 24 s√©jours UFOVAL vs BDD</div>
      <span class="blocker">üîí Input Specification</span>
    </div>
    <div class="flow-arrow">‚Üí</div>
    <div class="flow-step p2">
      <div class="step-label">Phase 2 ‚Äî CONDITIONN√â PAR P1</div>
      <div class="step-title">üîß Fix SQL Structurel</div>
      <div class="step-desc">Corrections BDD bas√©es sur r√©sultats audit</div>
      <span class="prereq">Attend P1 termin√©</span>
    </div>
    <div class="flow-arrow">‚Üí</div>
    <div class="flow-step p3">
      <div class="step-label">Phase 3 ‚Äî CONDITIONN√â PAR P2</div>
      <div class="step-title">‚öôÔ∏è Update n8n Sync</div>
      <div class="step-desc">Refonte workflow scraper post-correction BDD</div>
      <span class="prereq">Attend P2 termin√©</span>
    </div>
    <div class="flow-arrow">‚Üí</div>
    <div class="flow-step p4">
      <div class="step-label">Phase 4 ‚Äî CONDITIONN√â PAR P1+P2+P3</div>
      <div class="step-title">üöÄ Go-Live VPS</div>
      <div class="step-desc">.env production + d√©ploiement Hostinger</div>
      <span class="blocker">üîí Bloquant depuis 16/02</span>
    </div>
  </div>
</div>

<!-- R√àGLES GEL√âES -->
<div class="rules-box">
  <h3>üìå R√®gles fig√©es par l'audit ‚Äî Ne jamais d√©roger avant Go-Live</h3>
  <div class="rule-item">
    <div class="rule-num">1</div>
    <div class="rule-text">
      <strong>Formule dur√©e fig√©e : <code>end_date - start_date + 1</code> = jours inclusifs</strong>
      <span>UFOVAL compte le jour d'arriv√©e ET le jour de d√©part. Cette formule doit √™tre utilis√©e partout : BDD, n8n, front (stay-detail.tsx L192-198 ‚úÖ d√©j√† correct), SQL d'audit.</span>
    </div>
  </div>
  <div class="rule-item">
    <div class="rule-num">2</div>
    <div class="rule-text">
      <strong>Cl√© unique BDD : <code>stay_slug + start_date</code> ‚Äî Abandon de <code>id</code> et <code>date_text</code></strong>
      <span>Confirm√© par sql_fix_report. PK composite gd_stay_sessions = (stay_slug, start_date). gd_session_prices matching = start_date + end_date (type DATE ISO, pas date_text DD/MM-DD/MM).</span>
    </div>
  </div>
  <div class="rule-item">
    <div class="rule-num">3</div>
    <div class="rule-text">
      <strong>Boucle it√©rative scraper UFOVAL sur toutes les valeurs du s√©lecteur de dur√©e</strong>
      <span>Le scraper n8n actuel n'importe que la dur√©e par d√©faut du dropdown (ex: 7j). Pour chaque s√©jour multi-dur√©es (7j/14j/21j), it√©rer sur chaque option &lt;select&gt; avant de scraper les sessions.</span>
    </div>
  </div>
</div>

<!-- PHASE 1 : AUDIT 24 S√âJOURS -->
<div class="section">
  <div class="section-hdr">
    <div class="phase-dot ph1"></div>
    <h3>PHASE 1 ‚Äî Validation Audit : V√©rification manuelle 24 s√©jours (Pr√©alable Bloquant)</h3>
    <span class="phase-tag tag-purple">INPUT SPECIFICATION</span>
  </div>
  <div class="section-body">

    <div class="alert alert-info">
      <strong>Objectif Phase 1 : Produire le r√©f√©rentiel de v√©rit√© des 24 s√©jours avant toute modification</strong>
      Ex√©cuter les SQL d'audit en lecture seule dans Supabase SQL Editor. Les r√©sultats alimentent le plan d'action de la Phase 2.
      Aucune √©criture en BDD pendant cette phase.
    </div>

    <!-- UNIVERS 1 -->
    <div class="univ-hdr">üèîÔ∏è UNIVERS 1 ‚Äî ADR√âNALINE & SENSATIONS (12-17 ans) ¬∑ 7 s√©jours</div>
    <div class="stays-grid">
      <div class="stay-card">
        <div class="sc-slug">dh-experience-11-13-ans</div>
        <div class="sc-name">GRAVITY BIKE PARK</div>
        <div class="sc-ufoval">UFOVAL: DH Experience 11-13 ans ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-error">10 sessions BDD</span>
          <span class="check c-error">14j manquant</span>
          <span class="check c-error">21j manquant</span>
          <span class="check c-error">5 is_full d√©sync</span>
          <span class="check c-warn">Off-by-one possible</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">destination-soleil</div>
        <div class="sc-name">RIVIERA SPEED CLUB</div>
        <div class="sc-ufoval">UFOVAL: Destination Soleil ¬∑ H√©rault-M√©diterran√©e</div>
        <div class="sc-checks">
          <span class="check c-error">Prix PRICE_NOT_FOUND</span>
          <span class="check c-error">1 row prix / 3 sessions</span>
          <span class="check c-pending">Dur√©es √† v√©rifier</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">moto-moto</div>
        <div class="sc-name">MX RIDER ACADEMY</div>
        <div class="sc-ufoval">UFOVAL: Moto Moto ¬∑ Haute-Savoie Les Carroz</div>
        <div class="sc-checks">
          <span class="check c-info">12 sessions BDD</span>
          <span class="check c-pending">Dur√©es √† confirmer</span>
          <span class="check c-pending">Prix √† v√©rifier</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">annecy-element</div>
        <div class="sc-name">ALPINE SKY CAMP</div>
        <div class="sc-ufoval">UFOVAL: Annecy El√©ment ¬∑ Lac d'Annecy</div>
        <div class="sc-checks">
          <span class="check c-pending">Dur√©es √† v√©rifier</span>
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">sperienza-in-corsica-1</div>
        <div class="sc-name">CORSICA WILD TRIP</div>
        <div class="sc-ufoval">UFOVAL: Sperienza in Corsica ¬∑ Saint-Florent</div>
        <div class="sc-checks">
          <span class="check c-pending">Dur√©es √† v√©rifier</span>
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">surf-sur-le-bassin</div>
        <div class="sc-name">WEST COAST SURF CAMP</div>
        <div class="sc-ufoval">UFOVAL: Surf sur le Bassin ¬∑ Bassin d'Arcachon</div>
        <div class="sc-checks">
          <span class="check c-pending">Dur√©es √† v√©rifier</span>
          <span class="check c-warn">Overlap DUNE & OCEAN ?</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">aqua-fun</div>
        <div class="sc-name">AZUR DIVE & JET</div>
        <div class="sc-ufoval">UFOVAL: Aqua Fun ¬∑ Golfe St-Tropez</div>
        <div class="sc-checks">
          <span class="check c-pending">Dur√©es √† v√©rifier</span>
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
    </div>

    <!-- UNIVERS 2 -->
    <div class="univ-hdr">üå≤ UNIVERS 2 ‚Äî AVENTURE & D√âCOUVERTE (8-15 ans) ¬∑ 8 s√©jours</div>
    <div class="stays-grid">
      <div class="stay-card">
        <div class="sc-slug">les-robinson-des-glieres</div>
        <div class="sc-name">SURVIVOR CAMP 74</div>
        <div class="sc-ufoval">UFOVAL: Les Robinson des Gli√®res ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res (4-5 s√©jours)</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">survie-dans-le-beaufortain</div>
        <div class="sc-name">INTO THE WILD</div>
        <div class="sc-ufoval">UFOVAL: Survie dans le Beaufortain ¬∑ Savoie</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">yamakasi</div>
        <div class="sc-name">PARKOUR</div>
        <div class="sc-ufoval">UFOVAL: Yamakasi ¬∑ Savoie Courchevel</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-info">3 renommages (V3)</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">e-sport-and-sport</div>
        <div class="sc-name">GAMING HOUSE 1850</div>
        <div class="sc-ufoval">UFOVAL: E-Sport & Sport ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">explore-mountain</div>
        <div class="sc-name">ALPINE TREK JUNIOR</div>
        <div class="sc-ufoval">UFOVAL: Explore Mountain ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">mountain-and-chill</div>
        <div class="sc-name">ADRENALINE & CHILL</div>
        <div class="sc-ufoval">UFOVAL: Mountain & Chill ¬∑ Haute-Savoie</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">glieraventures</div>
        <div class="sc-name">DUAL CAMP : LAC & MONTAGNE</div>
        <div class="sc-ufoval">UFOVAL: Gli√®raventures ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">nature-picture</div>
        <div class="sc-name">WILDLIFE REPORTER</div>
        <div class="sc-ufoval">UFOVAL: Nature Picture ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res</span>
        </div>
      </div>
    </div>

    <!-- UNIVERS 3 -->
    <div class="univ-hdr">üåä UNIVERS 3 ‚Äî HORIZON OC√âAN & FUN (7-14 ans) ¬∑ 5 s√©jours</div>
    <div class="stays-grid">
      <div class="stay-card">
        <div class="sc-slug">breizh-equit-kids-8-11-ans</div>
        <div class="sc-name">BRETAGNE OCEAN RIDE</div>
        <div class="sc-ufoval">UFOVAL: Breizh Equit' Kids 8-11 ans ¬∑ Finist√®re</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">destination-bassin-darcachon-1</div>
        <div class="sc-name">DUNE & OCEAN KIDS</div>
        <div class="sc-ufoval">UFOVAL: Destination Bassin d'Arcachon ¬∑ Gironde</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Overlap WEST COAST ?</span>
          <span class="check c-warn">Dur√©es 7/12/14/19j ?</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">laventure-verticale</div>
        <div class="sc-name">ROCKS & PADDLE</div>
        <div class="sc-ufoval">UFOVAL: L'Aventure Verticale ¬∑ C√¥te bretonne</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Overlap SWIM ACADEMY ?</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">aqua-mix</div>
        <div class="sc-name">BLUE EXPERIENCE</div>
        <div class="sc-ufoval">UFOVAL: Aqua Mix ¬∑ Finist√®re littoral</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-info">3 renommages (V3)</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">aqua-gliss</div>
        <div class="sc-name">BABY RIDERS</div>
        <div class="sc-ufoval">UFOVAL: Aqua' Gliss ¬∑ Var Les Issambres</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Overlap BLUE EXPERIENCE ?</span>
        </div>
      </div>
    </div>

    <!-- UNIVERS 4 -->
    <div class="univ-hdr">üå≥ UNIVERS 4 ‚Äî MA PREMI√àRE COLO (3-9 ans) ¬∑ 4 s√©jours</div>
    <div class="stays-grid">
      <div class="stay-card">
        <div class="sc-slug">les-ptits-puisotins-1</div>
        <div class="sc-name">MY LITTLE FOREST</div>
        <div class="sc-ufoval">UFOVAL: Les P'tits Puisotins ¬∑ Semnoz</div>
        <div class="sc-checks">
          <span class="check c-info">14 sessions BDD</span>
          <span class="check c-error">6j au lieu 7j</span>
          <span class="check c-warn">SQL pr√™t, backup OK</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">croc-marmotte</div>
        <div class="sc-name">ALPOO KIDS</div>
        <div class="sc-ufoval">UFOVAL: Croc' Marmotte ¬∑ Savoie Beaufortain</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">natation-et-sensation</div>
        <div class="sc-name">SWIM ACADEMY</div>
        <div class="sc-ufoval">UFOVAL: Natation & Sensation ¬∑ St-Rapha√´l</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Overlap ROCKS & PADDLE ?</span>
        </div>
      </div>
      <div class="stay-card">
        <div class="sc-slug">les-apprentis-montagnards</div>
        <div class="sc-name">HUSKY ADVENTURE</div>
        <div class="sc-ufoval">UFOVAL: Les Apprentis Montagnards ¬∑ Gli√®res</div>
        <div class="sc-checks">
          <span class="check c-pending">Sessions √† compter</span>
          <span class="check c-warn">Cluster Gli√®res</span>
        </div>
      </div>
    </div>

    <!-- SQL Audit Phase 1 -->
    <div style="margin-top:20px;">
      <div class="code-label">SQL PHASE 1 ‚Äî Audit complet 24 s√©jours (lecture seule ‚Äî Copier dans Supabase SQL Editor)</div>
      <pre>-- ============================================================
-- AUDIT PHASE 1 ‚Äî 24 S√âJOURS ‚Äî R√âF√âRENTIEL DE V√âRIT√â
-- Sch√©ma r√©el : sans 'id', sans 'date_text'
-- Formule dur√©e : (end_date - start_date) + 1 = jours inclusifs
-- ============================================================

-- Q1 : Tableau de bord global ‚Äî Sessions + Dur√©es par s√©jour
SELECT
  ss.stay_slug,
  s.marketing_title                                       AS titre_ged,
  s.universe                                              AS univers,
  COUNT(*)                                                AS nb_sessions,
  MIN(ss.start_date)                                      AS premiere_session,
  MAX(ss.end_date)                                        AS derniere_session,
  STRING_AGG(
    DISTINCT ((ss.end_date::date - ss.start_date::date) + 1)::text,
    ', ' ORDER BY ((ss.end_date::date - ss.start_date::date) + 1)::text
  )                                                       AS durees_jours_inclusifs,
  COUNT(DISTINCT (ss.end_date::date - ss.start_date::date) + 1) AS nb_variantes_duree,
  SUM(CASE WHEN ss.is_full THEN 1 ELSE 0 END)             AS sessions_complet,
  COUNT(*) - COUNT(sp.price_ged_total)                    AS sessions_sans_prix
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s       ON s.slug = ss.stay_slug
LEFT JOIN gd_session_prices sp
  ON sp.stay_slug = ss.stay_slug
  AND sp.start_date = ss.start_date
  AND sp.end_date   = ss.end_date
GROUP BY ss.stay_slug, s.marketing_title, s.universe
ORDER BY
  CASE WHEN COUNT(*) - COUNT(sp.price_ged_total) > 0 THEN 0 ELSE 1 END,
  nb_sessions DESC;

-- Q2 : Sessions avec prix manquants (PRICE_NOT_FOUND risk)
SELECT
  ss.stay_slug,
  s.marketing_title,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours,
  sp.price_ged_total,
  '‚ùå PRIX MANQUANT ‚Äî inscription bloqu√©e'       AS alerte
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
LEFT JOIN gd_session_prices sp
  ON sp.stay_slug = ss.stay_slug
  AND sp.start_date = ss.start_date
  AND sp.end_date   = ss.end_date
WHERE sp.price_ged_total IS NULL
ORDER BY ss.stay_slug, ss.start_date;

-- Q3 : Dur√©es aberrantes (ni 7, ni 12, ni 14, ni 19, ni 21 jours)
SELECT
  ss.stay_slug,
  s.marketing_title,
  ss.start_date,
  ss.end_date,
  (ss.end_date::date - ss.start_date::date) + 1 AS duree_jours_inclusifs,
  '‚ö†Ô∏è Dur√©e hors r√©f√©rentiel UFOVAL'             AS alerte
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
WHERE (ss.end_date::date - ss.start_date::date) + 1
  NOT IN (6, 7, 12, 14, 19, 21)  -- 6j inclus pour d√©tecter les erreurs
ORDER BY ss.stay_slug, ss.start_date;

-- Q4 : is_full d√©synchronis√©
SELECT
  ss.stay_slug,
  s.marketing_title,
  ss.start_date,
  ss.end_date,
  ss.is_full,
  ss.seats_left,
  CASE
    WHEN ss.is_full = true  AND ss.seats_left > 0 THEN '‚ö†Ô∏è is_full=true mais places disponibles'
    WHEN ss.is_full = false AND ss.seats_left = 0 THEN '‚ö†Ô∏è is_full=false mais 0 places'
    ELSE '‚úÖ Coh√©rent'
  END AS statut_is_full
FROM gd_stay_sessions ss
LEFT JOIN gd_stays s ON s.slug = ss.stay_slug
WHERE ss.is_full = true
  OR (ss.is_full = false AND ss.seats_left = 0)
ORDER BY ss.stay_slug, ss.start_date;

-- Q5 : V√©rification sessions attendues GRAVITY BIKE PARK
SELECT
  (end_date::date - start_date::date) + 1 AS duree_jours_inclusifs,
  COUNT(*)                                  AS nb_sessions_bdd,
  STRING_AGG(TO_CHAR(start_date,'DD/MM/YYYY'), ', ' ORDER BY start_date) AS dates_debut
FROM gd_stay_sessions
WHERE stay_slug = 'dh-experience-11-13-ans'
GROUP BY 1 ORDER BY 1;
-- Attendu UFOVAL : 6j√ó?, 7j√ó8, 14j√ó?, 21j√ó? (total 14+ sessions)</pre>
    </div>

  </div>
</div>

<!-- PHASE 2 : FIX SQL -->
<div class="section">
  <div class="section-hdr">
    <div class="phase-dot ph2"></div>
    <h3>PHASE 2 ‚Äî Fix SQL Structurel (conditionn√© par r√©sultats Phase 1)</h3>
    <span class="phase-tag tag-info">√âCRITURE ‚Äî Apr√®s P1 valid√©</span>
  </div>
  <div class="section-body">

    <table>
      <thead>
        <tr>
          <th>Priorit√©</th>
          <th>Action SQL</th>
          <th>S√©jour</th>
          <th>Fichier / SQL</th>
          <th>Pr√©requis</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-error">P0</span></td>
          <td>Correction 6j ‚Üí 7j end_date</td>
          <td><strong>MY LITTLE FOREST</strong><br><code>les-ptits-puisotins-1</code></td>
          <td><code>CORRECTION_SESSION_6_JOURS_PTITS_PUISOTINS.sql</code><br>√âtape 1 (v√©rif) puis UPDATE d√©comment√©</td>
          <td>Backup <code>gd_stay_sessions_backup_6jours_ptits_puisotins</code> confirm√© OK</td>
          <td class="cell-warn">‚è≥ Pr√™t √† ex√©cuter</td>
        </tr>
        <tr>
          <td><span class="tag tag-error">P0</span></td>
          <td>INSERT sessions manquantes 14j + 21j</td>
          <td><strong>GRAVITY BIKE PARK</strong><br><code>dh-experience-11-13-ans</code></td>
          <td>SQL √† construire apr√®s Q5 Phase 1 (confirmation des gaps exacts)</td>
          <td>R√©sultat Q5 Phase 1 requis + dates UFOVAL confirm√©es</td>
          <td class="cell-error">‚ùå SQL Phase 1 requis d'abord</td>
        </tr>
        <tr>
          <td><span class="tag tag-error">P1</span></td>
          <td>INSERT grille tarifaire compl√®te (~19 rows)</td>
          <td><strong>RIVIERA SPEED CLUB</strong><br><code>destination-soleil</code></td>
          <td>INSERT gd_session_prices avec grille UFOVAL compl√®te</td>
          <td>Tarifs UFOVAL confirm√©s (scraper ou saisie manuelle)</td>
          <td class="cell-error">‚ùå Grille UFOVAL √† r√©cup√©rer</td>
        </tr>
        <tr>
          <td><span class="tag tag-warn">P2</span></td>
          <td>UPDATE is_full d√©synchronis√©</td>
          <td><strong>GRAVITY BIKE PARK</strong> + autres</td>
          <td>UPDATE is_full bas√© sur r√©sultat Q4 Phase 1</td>
          <td>R√©sultat Q4 Phase 1 requis</td>
          <td class="cell-error">‚ùå SQL Phase 1 requis d'abord</td>
        </tr>
        <tr>
          <td><span class="tag tag-warn">P2</span></td>
          <td>Corrections dur√©es off-by-one suppl√©mentaires</td>
          <td>Tous s√©jours √† r√©sultat Q3 Phase 1 "‚ö†Ô∏è"</td>
          <td>G√©n√©rer SQL UPDATE bas√© sur r√©sultat Q3</td>
          <td>R√©sultat Q3 Phase 1 requis</td>
          <td class="cell-error">‚ùå SQL Phase 1 requis d'abord</td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

<!-- PHASE 3 : N8N -->
<div class="section">
  <div class="section-hdr">
    <div class="phase-dot ph3"></div>
    <h3>PHASE 3 ‚Äî Update n8n Sync (conditionn√© par Phase 2 termin√©e)</h3>
    <span class="phase-tag tag-ok">WORKFLOW SCRAPER</span>
  </div>
  <div class="section-body">

    <div class="alert alert-warn">
      <strong>‚ö†Ô∏è Ne modifier le scraper n8n qu'apr√®s Phase 2 termin√©e</strong>
      Un scraper corrig√© qui tourne sur une BDD encore en erreur r√©introduirait les mauvaises donn√©es par-dessus les corrections SQL.
      S√©quence obligatoire : P2 termin√© ‚Üí snapshot BDD ‚Üí puis modifier n8n.
    </div>

    <div class="grid-2">
      <div>
        <div class="code-label">3.1 ‚Äî Mapping n≈ìud Supabase Upsert (avant ‚Üí apr√®s)</div>
        <pre>// AVANT ‚ùå (sch√©ma incorrect)
{
  "id": "{{ $json.scraped_id }}",
  "date_text": "{{ $json.date_label }}"
}

// APR√àS ‚úÖ (sch√©ma r√©el Supabase)
{
  "stay_slug": "{{ $json.slug }}",
  "start_date": "{{ $json.start_iso }}",  // YYYY-MM-DD
  "end_date":   "{{ $json.end_iso }}",    // YYYY-MM-DD
  "is_full":    "{{ $json.is_complet }}", // Boolean
  "seats_left": "{{ $json.places }}"     // Integer
}
// onConflict: ["stay_slug", "start_date"]</pre>
      </div>
      <div>
        <div class="code-label">3.2 ‚Äî Formule dur√©e (n≈ìud de transformation)</div>
        <pre>// AVANT ‚ùå (calcul en nuits = off-by-one)
const duree = end - start; // nuits seulement

// APR√àS ‚úÖ (jours inclusifs UFOVAL)
const startDate = new Date(scraped_start);
const endDate   = new Date(scraped_end);
const duree_jours = Math.ceil(
  (endDate - startDate) / (1000*60*60*24)
) + 1; // +1 pour jours inclusifs</pre>
      </div>
    </div>

    <div class="code-label" style="margin-top:16px;">3.3 ‚Äî Boucle sur toutes les dur√©es dropdown UFOVAL (pseudo-code n≈ìud n8n)</div>
    <pre>// N≈ìud "Split & Iterate Durations" ‚Äî √Ä ins√©rer AVANT "Fetch Sessions"
// Pour chaque s√©jour multi-dur√©es, it√©rer sur chaque option du s√©lecteur

const durationOptions = await page.evaluate(() => {
  const select = document.querySelector('select[name="duration"], #duration-select');
  if (!select) return [null]; // s√©jour dur√©e unique
  return Array.from(select.options).map(opt => ({
    value: opt.value,
    label: opt.text,
    days: parseInt(opt.text)  // ex: "7 jours" ‚Üí 7
  }));
});

// Pour chaque dur√©e : s√©lectionner, attendre rechargement, scraper sessions
for (const duration of durationOptions) {
  await page.select('select[name="duration"]', duration.value);
  await page.waitForNetworkIdle();
  const sessions = await scrapeSessions(); // extraire les sessions affich√©es
  await upsertToSupabase(sessions, {
    stay_slug: currentSlug,
    duration_days: duration.days
  });
}</pre>

  </div>
</div>

<!-- PHASE 4 : GO-LIVE -->
<div class="section">
  <div class="section-hdr">
    <div class="phase-dot ph4"></div>
    <h3>PHASE 4 ‚Äî Go-Live VPS Hostinger (conditionn√© par P1 + P2 + P3)</h3>
    <span class="phase-tag tag-warn">üîí BLOQUANT DEPUIS 16/02</span>
  </div>
  <div class="section-body">

    <div class="alert alert-error">
      <strong>Bloquant critique : .env.production VPS contient uniquement NEXT_DISABLE_STATIC_PAGE_GENERATION=true</strong>
      7 cl√©s manquantes emp√™chent le d√©marrage de l'application en production.
    </div>

    <ul class="checklist">
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>SUPABASE_SERVICE_ROLE_KEY</strong>
          <span>Cl√© service_role Supabase (acc√®s sans RLS pour les API routes inscriptions). R√©cup√©rer dans Supabase Dashboard ‚Üí Settings ‚Üí API.</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>NEXT_PUBLIC_SUPABASE_URL</strong>
          <span>URL projet Supabase. Format: https://[ref].supabase.co</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>NEXT_PUBLIC_SUPABASE_ANON_KEY</strong>
          <span>Cl√© anon Supabase (cl√© publique ‚Äî d√©j√† hardcod√©e en fallback dans supabaseGed.ts mais doit √™tre en env).</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>STRIPE_SECRET_KEY</strong>
          <span>Cl√© secr√®te Stripe pour traitement paiements. R√©cup√©rer dans Stripe Dashboard ‚Üí Developers ‚Üí API keys.</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>STRIPE_WEBHOOK_SECRET</strong>
          <span>Secret webhook Stripe. R√©cup√©rer dans Stripe Dashboard ‚Üí Webhooks ‚Üí [endpoint] ‚Üí Signing secret.</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">üîë</span>
        <div class="cl-text">
          <strong>EMAIL_SERVICE_API_KEY</strong>
          <span>Cl√© API service email (SendGrid / Resend / Mailjet). V√©rifier quel service est int√©gr√© dans /api/inscriptions.</span>
        </div>
      </li>
      <li>
        <span class="cl-icon">‚úÖ</span>
        <div class="cl-text">
          <strong>NEXT_DISABLE_STATIC_PAGE_GENERATION=true</strong>
          <span>D√©j√† pr√©sent dans .env.production. Requis pour √©viter les builds statiques qui appellent Supabase au build time.</span>
        </div>
      </li>
    </ul>

    <div class="code-label" style="margin-top:16px;">Commande SSH VPS ‚Äî V√©rification .env.production actuel</div>
    <pre># Se connecter en SSH au VPS Hostinger
ssh user@[ip-vps]

# V√©rifier contenu actuel
cat /var/www/ged-app/.env.production | grep -v "^#" | grep -v "^$"

# Ajouter les cl√©s manquantes
nano /var/www/ged-app/.env.production

# Red√©marrer l'application apr√®s ajout des cl√©s
cd /var/www/ged-app
pm2 restart ged-app   # ou docker-compose restart selon la config
pm2 logs ged-app      # v√©rifier les logs de d√©marrage</pre>

  </div>
</div>

<!-- CHECKLIST S√âQUENTIELLE FINALE -->
<div class="section">
  <div class="section-hdr">
    <div class="phase-dot" style="background:var(--accent);"></div>
    <h3>Checklist s√©quentielle finale ‚Äî Go / No-Go par phase</h3>
    <span class="phase-tag tag-gray">VALIDATION CROIS√âE</span>
  </div>
  <div class="section-body">
    <table>
      <thead>
        <tr>
          <th>Phase</th>
          <th>Condition de sortie (Go)</th>
          <th>Indicateur de blocage (No-Go)</th>
          <th>Action si No-Go</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>P1 ‚Äî Audit</strong></td>
          <td>SQL Q1-Q5 ex√©cut√©s, r√©sultats document√©s pour les 24 s√©jours. Tous les gaps identifi√©s.</td>
          <td>R√©sultats manquants pour ‚â•1 s√©jour, erreurs SQL inattendues</td>
          <td>Re-ex√©cuter SQL corrig√©, documenter avant de passer √† P2</td>
        </tr>
        <tr>
          <td><strong>P2 ‚Äî SQL Fix</strong></td>
          <td>MY LITTLE FOREST 6j‚Üí7j corrig√© ‚úÖ. GRAVITY BIKE PARK sessions 14j/21j ins√©r√©es. RIVIERA SPEED CLUB grille tarifaire compl√®te. is_full resync.</td>
          <td>Sessions_sans_prix > 0 sur s√©jour publi√©. Dur√©e aberrante restante. Backup non cr√©√©.</td>
          <td>NE PAS passer √† P3. Corriger et re-valider avec SQL Q1-Q5.</td>
        </tr>
        <tr>
          <td><strong>P3 ‚Äî n8n</strong></td>
          <td>Test scraper : 1 s√©jour multi-dur√©es import√© avec toutes variantes. Upsert idempotent v√©rifi√© (2√®me run = 0 doublon). Format ISO dates confirm√©.</td>
          <td>Doublons d√©tect√©s en BDD apr√®s run. Sessions 14j ou 21j non import√©es. is_full non resync.</td>
          <td>NE PAS passer √† P4. Debugger n≈ìud n8n et re-tester.</td>
        </tr>
        <tr>
          <td><strong>P4 ‚Äî Go-Live</strong></td>
          <td>.env.production complet (7 cl√©s). <code>pm2 logs</code> sans erreur. Page /sejour/[id] charge sans PRICE_NOT_FOUND. Inscription test r√©ussie.</td>
          <td>Erreur au d√©marrage (cl√© manquante). PRICE_MISMATCH sur test. Circuit /api/inscriptions KO.</td>
          <td>V√©rifier .env, logs Docker/PM2, tester /api/inscriptions en direct.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</main>

<footer>
  GED APP ‚Äî Workflow Ma√Ætre ¬∑ ALIGNMENT_PROTOCOL_ACTIVE ¬∑ economy_secure_no_regression ¬∑ 2026-02-18
  ¬∑ Phase 1 = Pr√©alable Bloquant ¬∑ 24 s√©jours ¬∑ 4 univers ¬∑ Sch√©ma r√©el Supabase int√©gr√©
</footer>

</body>
</html>
